import{j as e}from"./vendor-animation-CmxkKU9r.js";import"./vendor-react-DamxDR2H.js";import"./vendor-math-p018AHG0.js";import"./index-CsKt80eB.js";import{L as a,C as s,D as t,E as i}from"./Callout-DTLGvo9K.js";import"./vendor-firebase-functions-DDqfDrvm.js";import"./vendor-firebase-core-CzRQL6VN.js";import"./vendor-firebase-auth-C4l3lITM.js";import"./quizMap-C7tZlcUA.js";function p(){return e.jsxs(a,{sectionId:18,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"Network Protocol Extensions"}),e.jsx("p",{className:"mb-4",children:"BIP-144 extends the Bitcoin P2P protocol to support SegWit transactions. While BIP-141 defines the consensus rules, BIP-144 specifies how nodes communicate SegWit data over the networkâ€”including new message types and serialization formats."}),e.jsx(s,{type:"info",title:"Part of SegWit",children:e.jsx("p",{children:"BIP-144 deployed alongside BIP-141 and BIP-143 in August 2017. It ensures backward compatibility by allowing old nodes to continue functioning while new nodes can exchange witness data."})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The Serialization Problem"}),e.jsx("p",{className:"mb-4",children:"SegWit introduces witness data that old nodes don't understand. BIP-144 solves this with two serialization formats:"}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4 border border-blue-500/30",children:[e.jsx("p",{className:"text-blue-400 font-bold mb-2",children:"Legacy Format"}),e.jsx("p",{className:"text-sm text-dark-300",children:"Used when sending to old nodes or computing txid. No witness data included."})]}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4 border border-amber-500/30",children:[e.jsx("p",{className:"text-amber-400 font-bold mb-2",children:"Witness Format"}),e.jsx("p",{className:"text-sm text-dark-300",children:"Used between SegWit-aware nodes. Includes marker, flag, and witness data."})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Witness Serialization"}),e.jsx("p",{className:"mb-4",children:"The extended transaction format includes new fields:"}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-5 font-mono text-sm mb-6",children:[e.jsx("p",{className:"text-dark-400 mb-2",children:"# Extended transaction serialization"}),e.jsxs("div",{className:"space-y-1 text-dark-300",children:[e.jsx("p",{children:"[version: 4 bytes]"}),e.jsx("p",{className:"text-amber-400",children:"[marker: 1 byte = 0x00]"}),e.jsx("p",{className:"text-amber-400",children:"[flag: 1 byte = 0x01]"}),e.jsx("p",{children:"[input count: varint]"}),e.jsx("p",{children:"[inputs: variable]"}),e.jsx("p",{children:"[output count: varint]"}),e.jsx("p",{children:"[outputs: variable]"}),e.jsx("p",{className:"text-emerald-400",children:"[witness: variable, per-input]"}),e.jsx("p",{children:"[locktime: 4 bytes]"})]}),e.jsx("p",{className:"text-xs text-dark-500 mt-3",children:"Marker 0x00 followed by flag 0x01 indicates witness serialization"})]}),e.jsxs(t,{title:"Witness Structure",children:[e.jsx("p",{children:"For each input, the witness is a stack of items. Each item is a length-prefixed byte array. Empty witnesses (for non-SegWit inputs) have zero items."}),e.jsxs("div",{className:"mt-3 font-mono text-xs",children:[e.jsx("p",{children:"[item_count: varint]"}),e.jsx("p",{children:"[item_1_length: varint] [item_1_data: bytes]"}),e.jsx("p",{children:"[item_2_length: varint] [item_2_data: bytes]"}),e.jsx("p",{children:"..."})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Service Bit: NODE_WITNESS"}),e.jsx("p",{className:"mb-4",children:"BIP-144 defines a new service bit to advertise SegWit support:"}),e.jsx(i,{title:"NODE_WITNESS Service Bit",children:e.jsxs("div",{className:"space-y-3 text-dark-300",children:[e.jsx("p",{children:e.jsx("span",{className:"text-amber-400 font-mono",children:"NODE_WITNESS = (1 << 3) = 8"})}),e.jsx("p",{children:"Nodes advertising this bit:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-4",children:[e.jsx("li",{children:"Can provide witness data for transactions and blocks"}),e.jsx("li",{children:"Understand witness-serialized messages"}),e.jsx("li",{children:"Validate witness programs and scripts"})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"New Message Types"}),e.jsx("p",{className:"mb-4",children:"BIP-144 introduces variants of existing messages:"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm mb-6",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-dark-700",children:[e.jsx("th",{className:"text-left py-3 text-dark-300",children:"Message"}),e.jsx("th",{className:"text-left py-3 text-dark-300",children:"Type"}),e.jsx("th",{className:"text-left py-3 text-dark-300",children:"Description"})]})}),e.jsxs("tbody",{className:"text-dark-400",children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-3 text-amber-400",children:"MSG_WITNESS_TX"}),e.jsx("td",{children:"0x40000001"}),e.jsx("td",{children:"Request transaction with witness"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-3 text-amber-400",children:"MSG_WITNESS_BLOCK"}),e.jsx("td",{children:"0x40000002"}),e.jsx("td",{children:"Request block with witness"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-3 text-amber-400",children:"MSG_FILTERED_WITNESS_BLOCK"}),e.jsx("td",{children:"0x40000003"}),e.jsx("td",{children:"Filtered block with witness (for SPV)"})]})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Relay Behavior"}),e.jsx("p",{className:"mb-4",children:"Nodes handle transaction relay based on peer capabilities:"}),e.jsx("div",{className:"bg-dark-800/50 rounded-xl p-6 border border-dark-700/50 mb-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-amber-400 font-semibold mb-1",children:"To NODE_WITNESS peers:"}),e.jsx("p",{className:"text-dark-300",children:"Send full witness serialization. Include all witness data."})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-amber-400 font-semibold mb-1",children:"To non-witness peers:"}),e.jsx("p",{className:"text-dark-300",children:"Send legacy serialization only. Witness data is stripped."})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-amber-400 font-semibold mb-1",children:"Requesting data:"}),e.jsx("p",{className:"text-dark-300",children:"Use MSG_WITNESS_* types when requesting from NODE_WITNESS peers."})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"wtxid: Witness Transaction ID"}),e.jsxs(t,{title:"wtxid",children:[e.jsx("p",{children:"The hash of the full transaction including witness data. Unlike txid (which excludes witness), wtxid changes if witness data changes. Used for relay and mempool management."}),e.jsxs("div",{className:"mt-3 font-mono text-sm",children:[e.jsx("p",{children:"txid = SHA256d(legacy serialization)"}),e.jsx("p",{children:"wtxid = SHA256d(witness serialization)"})]})]}),e.jsx(i,{title:"txid vs wtxid",children:e.jsxs("div",{className:"space-y-3 text-dark-300",children:[e.jsx("p",{children:"For a SegWit transaction:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-2 ml-4",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"txid:"})," Used in block merkle tree, output references, consensus"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"wtxid:"})," Used in witness commitment, relay deduplication"]})]}),e.jsx("p",{className:"text-dark-500 mt-2 text-sm",children:"For legacy transactions, txid == wtxid (no witness data to include)"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Witness Commitment in Blocks"}),e.jsx("p",{className:"mb-4",children:"SegWit blocks include a commitment to all wtxids in the coinbase transaction:"}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-5 font-mono text-sm mb-6",children:[e.jsx("p",{className:"text-dark-400 mb-2",children:"# Coinbase witness commitment"}),e.jsx("p",{className:"text-dark-300",children:"OP_RETURN"}),e.jsx("p",{className:"text-amber-400",children:"0xaa21a9ed"}),e.jsx("p",{className:"text-dark-300",children:"[32-byte commitment]"}),e.jsx("p",{className:"text-xs text-dark-500 mt-3",children:"Commitment = SHA256d(witness_root || witness_reserved_value)"})]}),e.jsx(s,{type:"info",title:"Commitment Purpose",children:e.jsx("p",{children:"The witness commitment allows SPV clients to verify they have complete witness data. Without it, a malicious node could omit witness data, and the client couldn't tell. The commitment ties witness integrity to the block's proof-of-work."})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Backward Compatibility"}),e.jsx("p",{className:"mb-4",children:"BIP-144 maintains compatibility through careful design:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-2 mb-6 text-dark-300",children:[e.jsx("li",{children:"Old nodes receive legacy-serialized transactions (still valid)"}),e.jsx("li",{children:"The marker byte 0x00 can't start a valid legacy transaction (zero inputs)"}),e.jsx("li",{children:"Service bits allow nodes to discover peer capabilities"}),e.jsx("li",{children:"Blocks are valid to old nodes (they ignore witness data)"})]}),e.jsx(s,{type:"success",title:"Seamless Upgrade",children:e.jsx("p",{children:"BIP-144's careful protocol design allowed the network to upgrade gradually. Nodes could adopt SegWit at their own pace while maintaining full connectivity with peers using either serialization format."})})]})}export{p as default};
