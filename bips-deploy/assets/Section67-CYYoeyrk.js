import{j as e}from"./vendor-animation-CmxkKU9r.js";import"./vendor-react-DamxDR2H.js";import"./vendor-math-p018AHG0.js";import"./index-CsKt80eB.js";import{L as t,C as s,D as r,E as a}from"./Callout-DTLGvo9K.js";import"./vendor-firebase-functions-DDqfDrvm.js";import"./vendor-firebase-core-CzRQL6VN.js";import"./vendor-firebase-auth-C4l3lITM.js";import"./quizMap-C7tZlcUA.js";function p(){return e.jsxs(t,{sectionId:67,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"BIP-152: Compact Block Relay"}),e.jsx("p",{className:"mb-4",children:"BIP-152 introduced compact blocks, a major optimization for block propagation. Instead of sending full blocks, nodes send block headers with short transaction identifiers, allowing receivers to reconstruct blocks from their mempool."}),e.jsx(s,{type:"info",title:"Bandwidth Revolution",children:e.jsx("p",{children:"Compact blocks reduced block propagation bandwidth by ~99% in typical cases. Most transactions are already in mempools, so only short IDs need to be sent."})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The Problem"}),e.jsx("p",{className:"mb-4",children:"Traditional block propagation is wasteful:"}),e.jsx("div",{className:"bg-dark-800/50 rounded-xl p-6 border border-rose-500/30 mb-6",children:e.jsxs("ul",{className:"list-disc list-inside space-y-2 text-dark-300",children:[e.jsx("li",{children:"Full 1-4 MB blocks sent to each peer"}),e.jsx("li",{children:"Most transactions already in receiver's mempool"}),e.jsx("li",{children:"Same data transmitted multiple times"}),e.jsx("li",{children:"Slow propagation = more orphan blocks"}),e.jsx("li",{children:"Mining centralization pressure (fast connections win)"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Compact Block Structure"}),e.jsx(r,{title:"Compact Block",children:e.jsx("p",{children:"A block representation containing the header, short transaction IDs (6 bytes each), and prefilled transactions. The receiver reconstructs the full block using their mempool."})}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-5 font-mono text-sm mb-6",children:[e.jsx("p",{className:"text-dark-400 mb-2",children:"# Compact block contents:"}),e.jsx("p",{className:"text-dark-300",children:"header: 80 bytes (standard block header)"}),e.jsx("p",{className:"text-dark-300",children:"nonce: 8 bytes (for short ID calculation)"}),e.jsx("p",{className:"text-amber-400",children:"shortids: [6 bytes × n transactions]"}),e.jsx("p",{className:"text-dark-300",children:"prefilled_txs: [coinbase, + any missing]"}),e.jsx("p",{className:"text-dark-500 mt-3",children:"6-byte IDs vs ~500 byte average transactions = 99% savings"})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Protocol Messages"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm mb-6",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-dark-700",children:[e.jsx("th",{className:"text-left py-3 text-dark-300",children:"Message"}),e.jsx("th",{className:"text-left py-3 text-dark-300",children:"Purpose"})]})}),e.jsxs("tbody",{className:"text-dark-400",children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-3 font-mono text-amber-400",children:"sendcmpct"}),e.jsx("td",{children:"Negotiate compact block support + mode"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-3 font-mono text-amber-400",children:"cmpctblock"}),e.jsx("td",{children:"Send compact block"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-3 font-mono text-amber-400",children:"getblocktxn"}),e.jsx("td",{children:"Request missing transactions"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-3 font-mono text-amber-400",children:"blocktxn"}),e.jsx("td",{children:"Send requested transactions"})]})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Two Modes"}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4",children:[e.jsx("p",{className:"text-amber-400 font-bold mb-2",children:"Low Bandwidth Mode"}),e.jsxs("ul",{className:"text-sm text-dark-300 space-y-1",children:[e.jsx("li",{children:"sendcmpct(0, version)"}),e.jsx("li",{children:"Wait for header announcement"}),e.jsx("li",{children:"Request compact block"}),e.jsx("li",{children:"Good for most peers"})]})]}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4",children:[e.jsx("p",{className:"text-amber-400 font-bold mb-2",children:"High Bandwidth Mode"}),e.jsxs("ul",{className:"text-sm text-dark-300 space-y-1",children:[e.jsx("li",{children:"sendcmpct(1, version)"}),e.jsx("li",{children:"Receive compact block immediately"}),e.jsx("li",{children:"No announcement first"}),e.jsx("li",{children:"Fastest, for select peers"})]})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Reconstruction Process"}),e.jsx(a,{title:"Compact Block Flow",children:e.jsxs("div",{className:"space-y-3 font-mono text-xs",children:[e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4",children:[e.jsx("p",{className:"text-dark-400 mb-2",children:"# 1. Receive compact block:"}),e.jsx("p",{className:"text-dark-300",children:"cmpctblock(header, nonce, shortids, prefilled)"})]}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4",children:[e.jsx("p",{className:"text-dark-400 mb-2",children:"# 2. Compute expected short IDs:"}),e.jsx("p",{className:"text-dark-300",children:"for tx in mempool:"}),e.jsx("p",{className:"text-dark-500 ml-4",children:"expected_id = siphash(nonce, tx.wtxid)[0:6]"})]}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4",children:[e.jsx("p",{className:"text-dark-400 mb-2",children:"# 3. Match short IDs to mempool txs:"}),e.jsx("p",{className:"text-dark-300",children:"block_txs = match(shortids, mempool)"})]}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4",children:[e.jsx("p",{className:"text-dark-400 mb-2",children:"# 4. Request any missing:"}),e.jsx("p",{className:"text-dark-300",children:"if missing_txs:"}),e.jsx("p",{className:"text-dark-500 ml-4",children:"send getblocktxn(missing_indices)"}),e.jsx("p",{className:"text-dark-500 ml-4",children:"receive blocktxn(missing_txs)"})]}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4",children:[e.jsx("p",{className:"text-dark-400 mb-2",children:"# 5. Validate complete block:"}),e.jsx("p",{className:"text-emerald-400",children:"validate_block(header, all_txs)"})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Short ID Calculation"}),e.jsx("p",{className:"mb-4",children:"Short IDs use SipHash for collision resistance:"}),e.jsxs("div",{className:"bg-dark-800/50 rounded-xl p-6 border border-dark-700/50 mb-6",children:[e.jsxs("div",{className:"font-mono text-sm text-dark-300",children:[e.jsx("p",{children:"key = SHA256(header || nonce)[0:16]"}),e.jsx("p",{className:"mt-2",children:"short_id = SipHash-2-4(key, wtxid)[0:6]"})]}),e.jsx("p",{className:"text-dark-500 text-sm mt-3",children:"6 bytes = 48 bits → very low collision probability in one block"})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Version 2"}),e.jsx("p",{className:"mb-4",children:"BIP-152 version 2 added SegWit support:"}),e.jsx("div",{className:"bg-dark-800/50 rounded-xl p-6 border border-dark-700/50 mb-6",children:e.jsxs("ul",{className:"list-disc list-inside space-y-2 text-dark-300",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Version 1:"})," Uses txid for short ID calculation"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Version 2:"})," Uses wtxid (includes witness data)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"SegWit required:"})," Version 2 requires NODE_WITNESS"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Default today:"})," All modern nodes use version 2"]})]})}),e.jsx(s,{type:"warning",title:"Mempool Sync Important",children:e.jsx("p",{children:"Compact blocks work best when mempools are synchronized. If a receiver's mempool differs significantly (missing transactions), more round trips are needed. This motivates transaction relay optimizations like Erlay (BIP-330)."})}),e.jsx(s,{type:"success",title:"Network Impact",children:e.jsx("p",{children:"Compact blocks transformed Bitcoin block propagation. Combined with FIBRE and similar optimizations, block propagation times dropped from seconds to milliseconds, reducing orphan rates and improving mining decentralization."})})]})}export{p as default};
