import{j as e}from"./vendor-animation-CmxkKU9r.js";import"./vendor-react-DamxDR2H.js";import"./vendor-math-p018AHG0.js";import"./index-BjhgI7Zp.js";import{L as a,C as t,E as s,D as i}from"./Callout-Bm0ChKkk.js";import"./vendor-firebase-functions-DDqfDrvm.js";import"./vendor-firebase-core-CzRQL6VN.js";import"./vendor-firebase-auth-C4l3lITM.js";import"./quizMap-C7tZlcUA.js";function p(){return e.jsxs(a,{sectionId:14,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"Script-Level Relative Locks"}),e.jsxs("p",{className:"mb-4",children:["BIP-112 introduces ",e.jsx("strong",{children:"OP_CHECKSEQUENCEVERIFY"})," (CSV), the script-level counterpart to BIP-68. While BIP-68 lets transaction creators set relative locks, CSV lets output creators ",e.jsx("em",{children:"require"})," them—essential for trustless payment channels."]}),e.jsx(t,{type:"info",title:"Activated: July 2016",children:e.jsx("p",{children:'BIP-112 activated alongside BIP-68 and BIP-113 as part of the "CSV soft fork," the first deployment using BIP-9 version bits signaling.'})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The Need for Script Enforcement"}),e.jsx("p",{className:"mb-4",children:"BIP-68 alone isn't enough. Consider this scenario:"}),e.jsx(s,{title:"Why BIP-68 Isn't Sufficient",children:e.jsxs("div",{className:"space-y-3 text-dark-300",children:[e.jsx("p",{children:'Alice creates an output: "Spendable by Bob OR by Alice after 1 week"'}),e.jsx("p",{className:"text-dark-400",children:"Without CSV:"}),e.jsxs("ul",{className:"list-disc list-inside ml-4 space-y-1",children:[e.jsx("li",{children:"Bob can spend immediately (his branch has no timelock)"}),e.jsx("li",{children:"Alice must wait 1 week for her branch"}),e.jsx("li",{children:"But there's no way to enforce this in the script!"})]}),e.jsx("p",{className:"text-amber-400 mt-2",children:"BIP-68 only checks nSequence—nothing forces Bob to use a specific nSequence value."})]})}),e.jsx(i,{title:"OP_CHECKSEQUENCEVERIFY (CSV)",children:e.jsx("p",{children:"A script opcode that verifies the spending transaction's input nSequence value is at least as large as the value on the stack. Similar to how CLTV enforces nLockTime, CSV enforces nSequence for relative time locks."})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"How CSV Works"}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-5 font-mono text-sm mb-6",children:[e.jsx("p",{className:"text-dark-400 mb-2",children:"# Example: Can't spend until 144 blocks after confirmation"}),e.jsx("p",{className:"text-amber-400 mb-4",children:"<144> OP_CHECKSEQUENCEVERIFY OP_DROP OP_DUP OP_HASH160 <hash> OP_EQUALVERIFY OP_CHECKSIG"}),e.jsx("p",{className:"text-dark-400 mb-2",children:"# To spend, the transaction must have:"}),e.jsx("p",{className:"text-emerald-400",children:"input.nSequence ≥ 144 (with BIP-68 enabled)"}),e.jsx("p",{className:"text-emerald-400",children:"Transaction version ≥ 2"})]}),e.jsx(s,{title:"CSV Validation Steps",children:e.jsxs("ol",{className:"list-decimal list-inside space-y-2 text-dark-300",children:[e.jsx("li",{children:"Push the required sequence value onto the stack (e.g., 144)"}),e.jsxs("li",{children:["OP_CHECKSEQUENCEVERIFY checks:",e.jsxs("ul",{className:"list-disc list-inside ml-6 mt-1 space-y-1",children:[e.jsx("li",{children:"Is transaction version ≥ 2? (required for BIP-68)"}),e.jsx("li",{children:"Is the stack value negative? → FAIL"}),e.jsx("li",{children:"Is input.nSequence's disable flag set? → FAIL"}),e.jsx("li",{children:"Do the type flags match? → FAIL if mismatched"}),e.jsx("li",{children:"Is input.nSequence < stack value? → FAIL"})]})]}),e.jsx("li",{children:"If all checks pass, execution continues"}),e.jsx("li",{children:"OP_DROP removes the sequence value"}),e.jsx("li",{children:"Script continues with remaining operations"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Relationship with BIP-68"}),e.jsx("p",{className:"mb-4",children:"CSV and BIP-68 work together:"}),e.jsx("div",{className:"bg-dark-800/50 rounded-xl p-6 border border-dark-700/50 mb-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("span",{className:"text-amber-400 font-bold",children:"1."}),e.jsx("p",{className:"text-dark-300",children:'CSV in the script says "the spender must provide nSequence ≥ X"'})]}),e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("span",{className:"text-amber-400 font-bold",children:"2."}),e.jsx("p",{className:"text-dark-300",children:'BIP-68 consensus rules say "if nSequence encodes a relative lock, the input must have aged appropriately"'})]}),e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("span",{className:"text-amber-400 font-bold",children:"3."}),e.jsx("p",{className:"text-dark-300",children:"Together: script enforces a minimum, and consensus ensures that minimum is actually met relative to confirmation time"})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Common Script Patterns"}),e.jsx(s,{title:"CSV Script Examples",children:e.jsxs("div",{className:"space-y-5 font-mono text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-dark-400 mb-1",children:"# Simple relative timelock"}),e.jsx("p",{className:"text-amber-400",children:"<sequence> CSV DROP <pubkey> CHECKSIG"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-dark-400 mb-1",children:"# Immediate OR delayed payment"}),e.jsx("p",{className:"text-amber-400",children:"IF <pubkeyA> CHECKSIG ELSE <delay> CSV DROP <pubkeyB> CHECKSIG ENDIF"}),e.jsx("p",{className:"text-xs text-dark-500 mt-1",children:"A can spend immediately; B must wait <delay> blocks"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-dark-400 mb-1",children:"# Lightning revocation pattern"}),e.jsx("p",{className:"text-amber-400",children:"IF <revocationKey> CHECKSIG ELSE <toSelfDelay> CSV DROP <localKey> CHECKSIG ENDIF"}),e.jsx("p",{className:"text-xs text-dark-500 mt-1",children:"Counterparty can claim immediately with revocation key; owner waits"})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Use in Payment Channels"}),e.jsx("p",{className:"mb-4",children:"CSV is crucial for Lightning Network security:"}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"bg-dark-800/50 rounded-xl p-5 border border-dark-700/50",children:[e.jsx("h4",{className:"text-lg font-semibold text-amber-400 mb-2",children:"Revocation Mechanism"}),e.jsx("p",{className:"text-dark-300",children:"When Alice updates the channel state, she gives Bob a revocation key for her old state. If Alice later broadcasts the old state, Bob has <delay> blocks to use the revocation key and claim all funds. CSV creates this enforcement window."})]}),e.jsxs("div",{className:"bg-dark-800/50 rounded-xl p-5 border border-dark-700/50",children:[e.jsx("h4",{className:"text-lg font-semibold text-amber-400 mb-2",children:"Unilateral Close"}),e.jsx("p",{className:"text-dark-300",children:"When closing a channel without cooperation, CSV ensures both parties have time to respond. The delay prevents instant sweeping that could enable race conditions."})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"CLTV vs CSV"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm mb-6",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-dark-700",children:[e.jsx("th",{className:"text-left py-3 text-dark-300",children:"Feature"}),e.jsx("th",{className:"text-left py-3 text-dark-300",children:"CLTV (BIP-65)"}),e.jsx("th",{className:"text-left py-3 text-dark-300",children:"CSV (BIP-112)"})]})}),e.jsxs("tbody",{className:"text-dark-400",children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-3",children:"Lock type"}),e.jsx("td",{children:"Absolute"}),e.jsx("td",{children:"Relative"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-3",children:"Reference point"}),e.jsx("td",{children:"Fixed block/time"}),e.jsx("td",{children:"Input confirmation"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-3",children:"Field checked"}),e.jsx("td",{children:"nLockTime"}),e.jsx("td",{children:"nSequence"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-3",children:"Primary use"}),e.jsx("td",{children:"HTLCs, inheritance"}),e.jsx("td",{children:"Payment channels"})]})]})]})}),e.jsx(t,{type:"success",title:"Enabling Lightning",children:e.jsx("p",{children:"BIP-112 was a critical prerequisite for Lightning Network. Without script-enforceable relative timelocks, the penalty mechanism that keeps channels secure wouldn't be possible. CSV is embedded in every Lightning commitment transaction."})})]})}export{p as default};
