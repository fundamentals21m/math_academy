import{j as e}from"./vendor-animation-CmxkKU9r.js";import"./vendor-react-DamxDR2H.js";import"./vendor-math-p018AHG0.js";import"./index-BjhgI7Zp.js";import{L as i,C as s,D as l,E as t}from"./Callout-Bm0ChKkk.js";import"./vendor-firebase-functions-DDqfDrvm.js";import"./vendor-firebase-core-CzRQL6VN.js";import"./vendor-firebase-auth-C4l3lITM.js";import"./quizMap-C7tZlcUA.js";function p(){return e.jsxs(i,{sectionId:19,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"Fixing the CHECKMULTISIG Bug"}),e.jsx("p",{className:"mb-4",children:`BIP-147 addresses a long-standing quirk in Bitcoin's OP_CHECKMULTISIG: the infamous "dummy element" bug. This soft fork requires the dummy to be null, eliminating a malleability vector that persisted even after SegWit.`}),e.jsx(s,{type:"info",title:"Activated with SegWit",children:e.jsx("p",{children:"BIP-147 activated as part of SegWit in August 2017. It applies only to SegWit scripts (witness programs), not to legacy P2SH multisig."})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The Original Bug"}),e.jsx("p",{className:"mb-4",children:"OP_CHECKMULTISIG and OP_CHECKMULTISIGVERIFY have a well-known implementation quirk: they consume one more stack element than expected."}),e.jsx(l,{title:"The Dummy Element",children:e.jsx("p",{children:"Due to an off-by-one error in the original Bitcoin implementation, CHECKMULTISIG pops N+1 items from the stack (where N is the number of signatures). The extra element is not used for anything—it's just consumed and discarded."})}),e.jsx(t,{title:"Standard Multisig Script Execution",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-dark-300 mb-2",children:"For a 2-of-3 multisig:"}),e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-4 rounded-lg overflow-x-auto",children:[e.jsx("p",{className:"text-dark-400 mb-1",children:"# ScriptSig (spending side)"}),e.jsx("p",{className:"text-amber-400 mb-3",children:"<dummy> <sig1> <sig2>"}),e.jsx("p",{className:"text-dark-400 mb-1",children:"# ScriptPubKey (locking side)"}),e.jsx("p",{className:"text-emerald-400",children:"OP_2 <pk1> <pk2> <pk3> OP_3 OP_CHECKMULTISIG"})]}),e.jsx("p",{className:"text-dark-500 text-sm mt-2",children:"The <dummy> element is required but ignored. Historically, any value worked."})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Why This Is a Problem"}),e.jsx("p",{className:"mb-4",children:"The fact that the dummy element is ignored creates a malleability vector:"}),e.jsx("div",{className:"bg-dark-800/50 rounded-xl p-6 border border-dark-700/50 mb-6",children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-rose-400 font-semibold mb-1",children:"Malleability Attack"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-dark-300 ml-4",children:[e.jsx("li",{children:"Valid transaction uses dummy = OP_0 (empty)"}),e.jsx("li",{children:"Attacker changes dummy to 0x01 or any other value"}),e.jsx("li",{children:"Transaction remains valid (dummy is ignored)"}),e.jsx("li",{children:"But the txid/wtxid changes!"})]})]})})}),e.jsx(s,{type:"warning",title:"Pre-SegWit Impact",children:e.jsx("p",{children:"Before SegWit, this was part of the broader scriptSig malleability problem. After SegWit moved signatures to the witness, the dummy element remained in the witness stack—still malleable for P2WSH multisig."})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The BIP-147 Fix"}),e.jsx("p",{className:"mb-4",children:"BIP-147 adds a simple consensus rule:"}),e.jsxs("div",{className:"bg-emerald-500/10 rounded-xl p-6 border border-emerald-500/30 mb-6",children:[e.jsx("p",{className:"text-emerald-400 font-bold text-lg mb-2",children:"NULLDUMMY Rule"}),e.jsx("p",{className:"text-dark-300",children:"For SegWit scripts, the dummy element consumed by CHECKMULTISIG and CHECKMULTISIGVERIFY MUST be an empty byte array (OP_0 / 0x00)."}),e.jsx("p",{className:"text-dark-500 text-sm mt-2",children:"Any other value causes the script to fail immediately."})]}),e.jsx(t,{title:"Valid vs Invalid After BIP-147",children:e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4",children:[e.jsx("p",{className:"text-emerald-400 font-semibold mb-2",children:"✓ Valid"}),e.jsx("p",{className:"font-mono text-sm text-dark-300",children:"<OP_0> <sig1> <sig2>"}),e.jsx("p",{className:"text-xs text-dark-500 mt-1",children:"Empty dummy element"})]}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4",children:[e.jsx("p",{className:"text-rose-400 font-semibold mb-2",children:"✗ Invalid"}),e.jsx("p",{className:"font-mono text-sm text-dark-300",children:"<0x01> <sig1> <sig2>"}),e.jsx("p",{className:"text-xs text-dark-500 mt-1",children:"Non-empty dummy → script fails"})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Why Not Fix the Bug Properly?"}),e.jsx("p",{className:"mb-4",children:"You might wonder: why not just fix CHECKMULTISIG to not consume the extra element? Several reasons:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-2 mb-6 text-dark-300",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Hard fork required:"})," Changing opcode behavior for existing scripts would invalidate currently-valid transactions"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Script semantics:"})," Stack depth expectations would change, potentially breaking complex scripts"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"SegWit opportunity:"})," New witness scripts could have new rules without affecting legacy"]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Scope of BIP-147"}),e.jsx("p",{className:"mb-4",children:"BIP-147 only applies to witness scripts:"}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4 border border-emerald-500/30",children:[e.jsx("p",{className:"text-emerald-400 font-bold mb-2",children:"NULLDUMMY Enforced"}),e.jsxs("ul",{className:"text-sm text-dark-300 space-y-1",children:[e.jsx("li",{children:"P2WSH multisig"}),e.jsx("li",{children:"P2SH-P2WSH multisig"}),e.jsx("li",{children:"Witness scripts using CHECKMULTISIG*"})]})]}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-4 border border-amber-500/30",children:[e.jsx("p",{className:"text-amber-400 font-bold mb-2",children:"NULLDUMMY Not Required"}),e.jsxs("ul",{className:"text-sm text-dark-300 space-y-1",children:[e.jsx("li",{children:"Legacy P2SH multisig"}),e.jsx("li",{children:"Bare multisig"}),e.jsx("li",{children:"P2PKH (no multisig)"})]}),e.jsx("p",{className:"text-xs text-dark-500 mt-2",children:"(Though standardness rules encourage OP_0)"})]})]}),e.jsx(s,{type:"info",title:"Standardness vs Consensus",children:e.jsx("p",{children:"Even before BIP-147, Bitcoin Core's standardness rules preferred OP_0 for the dummy. Non-standard transactions would relay but eventually confirm. BIP-147 elevated this to a consensus rule for SegWit, making non-null dummies invalid—not just non-standard."})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Taproot Eliminates the Issue"}),e.jsx("p",{className:"mb-4",children:"BIP-147 is specific to SegWit v0. Taproot (v1) uses Schnorr signatures, which have a different multisig approach:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-2 mb-6 text-dark-300",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"MuSig2:"})," Multiple signers produce a single aggregated signature"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"OP_CHECKSIGADD:"})," New opcode for threshold signatures, no dummy needed"]}),e.jsx("li",{children:"No CHECKMULTISIG in Tapscript—the bug doesn't exist in v1"})]}),e.jsx(s,{type:"success",title:"Complete Malleability Fix",children:e.jsx("p",{children:"BIP-147 was the final piece needed to make SegWit transactions fully non-malleable. With strict DER (BIP-66), low-S values, and now NULLDUMMY, there are no remaining ways to modify a valid SegWit transaction without invalidating it."})})]})}export{p as default};
