<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Security: Content Security Policy to mitigate XSS attacks -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://www.gstatic.com https://*.firebaseio.com https://*.googleapis.com 'unsafe-inline';
    style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.cloudfunctions.net wss://*.firebaseio.com;
    frame-ancestors 'none';
    base-uri 'self';
    form-action 'self';
  ">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">
  <title>Course Admin - Magic Internet Math</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/admin.css">

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
    import { firebaseConfig } from './scripts/firebase-config.js';

    // Initialize Firebase
    window.firebaseApp = initializeApp(firebaseConfig);
    window.firebaseFunctions = getFunctions(window.firebaseApp);

    // Export callable functions
    window.callFunction = async function(name, data = {}) {
      const fn = httpsCallable(window.firebaseFunctions, name);
      const result = await fn(data);
      return result.data;
    };
  </script>

  <!-- Nostr Auth -->
  <script type="module" src="./scripts/nostrAuth.js"></script>

  <!-- Admin Renderer -->
  <script type="module" src="./scripts/adminRenderer.js"></script>
</head>
<body>
  <nav>
    <div class="nav-content">
      <a href="index.html" class="logo">Magic Internet Math</a>
      <div style="display: flex; align-items: center; gap: 2rem;">
        <ul class="nav-links">
          <li><a href="index.html">Courses</a></li>
          <li><a href="admin.html" class="active">Admin</a></li>
        </ul>
        <div id="nostr-auth-container"></div>
      </div>
    </div>
  </nav>

  <main class="admin-container">
    <!-- Loading State -->
    <div id="loading-state" class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-text">Checking admin access...</p>
    </div>

    <!-- Access Denied State -->
    <div id="access-denied" class="access-denied" style="display: none;">
      <div class="error-icon">ðŸ”’</div>
      <h2>Access Denied</h2>
      <p>You must be logged in with a Nostr account that has admin privileges.</p>
      <a href="index.html" class="btn-primary">Back to Courses</a>
    </div>

    <!-- Admin Content (hidden until authenticated) -->
    <div id="admin-content" style="display: none;">
      <header class="admin-header">
        <h1>Course Management</h1>
        <div class="admin-header-actions">
          <a href="index.html" class="back-link">
            <span>&larr;</span> Back to Hub
          </a>
        </div>
      </header>

      <div class="admin-panels">
        <!-- Categories Panel -->
        <div class="panel">
          <div class="panel-header">
            <h2>Categories</h2>
            <button class="btn-primary btn-small" id="add-category-btn">+ Add</button>
          </div>
          <div class="panel-content">
            <div id="category-list" class="category-list">
              <!-- Rendered by adminRenderer.js -->
            </div>
          </div>
        </div>

        <!-- Courses Panel -->
        <div class="panel" style="grid-column: span 1;">
          <div class="panel-header">
            <h2>Courses</h2>
          </div>
          <div class="panel-content">
            <div class="courses-controls">
              <select id="category-filter">
                <option value="">All Courses (no category focus)</option>
                <!-- Options rendered dynamically -->
              </select>
              <input type="text" id="course-search" placeholder="Search courses...">
            </div>
            <p id="category-hint" style="color: #64748b; font-size: 0.75rem; margin-bottom: 1rem; display: none;">
              Select a category above to quickly add/remove courses from it
            </p>
            <div id="course-list" class="course-list">
              <!-- Rendered by adminRenderer.js -->
            </div>
          </div>
        </div>
      </div>

      <!-- Admins Panel -->
      <div class="panel admins-panel">
        <div class="panel-header">
          <h2>Administrators</h2>
          <button class="btn-primary btn-small" id="add-admin-btn">+ Add Admin</button>
        </div>
        <div class="panel-content">
          <div id="admin-list" class="admin-list">
            <!-- Rendered by adminRenderer.js -->
          </div>
        </div>
      </div>
    </div>

    <!-- Unsaved Changes Banner -->
    <div id="unsaved-banner" class="unsaved-banner" style="display: none;">
      <p>You have unsaved changes</p>
      <button class="btn-save" id="save-changes-btn">Save Changes</button>
      <button class="btn-discard" id="discard-changes-btn">Discard</button>
    </div>
  </main>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Add Category Modal -->
  <div id="category-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 id="category-modal-title">Add Category</h3>
        <button class="modal-close" id="close-category-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="category-title">Title</label>
          <input type="text" id="category-title" placeholder="e.g., Physics">
        </div>
        <div class="form-group">
          <label for="category-subtitle">Subtitle</label>
          <input type="text" id="category-subtitle" placeholder="e.g., Motion, energy, and forces">
        </div>
        <div class="form-group">
          <label for="category-style">Style</label>
          <select id="category-style">
            <option value="subject">Subject (default)</option>
            <option value="featured">Featured (highlighted)</option>
            <option value="beginner">Beginner (green accent)</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancel-category-btn">Cancel</button>
        <button class="btn-primary" id="save-category-btn">Save Category</button>
      </div>
    </div>
  </div>

  <!-- Add Admin Modal -->
  <div id="admin-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3>Add Administrator</h3>
        <button class="modal-close" id="close-admin-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="admin-npub">Nostr Public Key (npub)</label>
          <input type="text" id="admin-npub" placeholder="npub1...">
        </div>
        <div class="form-group">
          <label for="admin-display-name">Display Name (optional)</label>
          <input type="text" id="admin-display-name" placeholder="e.g., John Doe">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancel-admin-btn">Cancel</button>
        <button class="btn-primary" id="save-admin-btn">Add Admin</button>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div id="confirm-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3 id="confirm-modal-title">Confirm Delete</h3>
        <button class="modal-close" id="close-confirm-modal">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirm-modal-message">Are you sure you want to delete this item?</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancel-confirm-btn">Cancel</button>
        <button class="btn-danger" id="confirm-delete-btn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Edit Course Modal -->
  <div id="course-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3>Edit Course</h3>
        <button class="modal-close" id="close-course-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="course-title-input">Title</label>
          <input type="text" id="course-title-input" placeholder="Course title">
        </div>
        <div class="form-group">
          <label for="course-description-input">Description</label>
          <textarea id="course-description-input" rows="3" placeholder="Course description"></textarea>
        </div>
        <div class="form-group">
          <label for="course-icon-input">Icon</label>
          <input type="text" id="course-icon-input" placeholder="e.g., ðŸ“Š or xÂ²">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancel-course-btn">Cancel</button>
        <button class="btn-primary" id="save-course-btn">Save Course</button>
      </div>
    </div>
  </div>
</body>
</html>
