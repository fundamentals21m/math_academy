import{j as e,m as d,A as S}from"./vendor-animation-0o8UKZ_1.js";import{r as c}from"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-BbBpzejs.js";import{L as H}from"./LessonLayout-Bq4tucEw.js";import{M as g}from"./MathBlock-BfkVbDlQ.js";import{D as h,E as m,T as N,C as k}from"./Callout-BvJhqaqq.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";const T=[{id:"sender",name:"Sender",color:"bg-blue-500",icon:"üë§"},{id:"hop1",name:"Node A",color:"bg-purple-500",icon:"üîó"},{id:"hop2",name:"Node B",color:"bg-amber-500",icon:"üîó"},{id:"hop3",name:"Node C",color:"bg-green-500",icon:"üîó"},{id:"receiver",name:"Receiver",color:"bg-emerald-500",icon:"üí∞"}];function P({className:v=""}){const[n,x]=c.useState(0),[r,p]=c.useState("forward"),[j,u]=c.useState(!1),i=T,o=i.length*2-1,a=c.useMemo(()=>n===0?-1:r==="forward"?Math.min(n-1,i.length-1):i.length-1-(n-i.length),[n,r,i.length]),f=c.useMemo(()=>{if(r==="forward"){const s=i.length-1-a;return Math.max(0,s)}else return a+1},[r,a,i.length]),w=async()=>{if(j||n>=o)return;u(!0);const s=n+1;s>=i.length&&r==="forward"&&p("backward"),x(s),await new Promise(t=>setTimeout(t,500)),u(!1)},C=()=>{x(0),p("forward")},b=s=>n===0?"waiting":r==="forward"?s<a?"processed":s===a?"active":"waiting":s>a?"fulfilled":s===a?"active":"processed";return e.jsxs("div",{className:`bg-dark-900 rounded-2xl p-6 ${v}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-dark-100",children:"Onion Routing Visualizer"}),e.jsx("button",{onClick:C,className:"px-3 py-1 text-sm bg-dark-700 hover:bg-dark-600 text-dark-300 rounded-lg transition-colors",children:"Reset"})]}),e.jsx("div",{className:"flex justify-center mb-6",children:e.jsxs("div",{className:"inline-flex bg-dark-800 rounded-lg p-1",children:[e.jsx("div",{className:`px-4 py-2 rounded-md text-sm font-medium transition-colors ${r==="forward"?"bg-blue-500/20 text-blue-400":"text-dark-500"}`,children:"‚ö° Payment Forward"}),e.jsx("div",{className:`px-4 py-2 rounded-md text-sm font-medium transition-colors ${r==="backward"?"bg-green-500/20 text-green-400":"text-dark-500"}`,children:"‚úì Preimage Return"})]})}),e.jsx("div",{className:"flex justify-center mb-8",children:e.jsxs("div",{className:"relative",children:[[...Array(4)].map((s,t)=>e.jsx(d.div,{className:"absolute rounded-full border-2",style:{width:120-t*20,height:120-t*20,left:t*10,top:t*10},animate:{opacity:t<f?1:.2,borderColor:t<f?`hsl(${40+t*30}, 70%, 50%)`:"rgb(55, 65, 81)"},transition:{duration:.3}},t)),e.jsx(d.div,{className:"w-20 h-20 rounded-full bg-amber-500/30 flex items-center justify-center text-3xl",style:{marginLeft:20,marginTop:20},animate:{scale:[1,1.1,1]},transition:{duration:2,repeat:1/0},children:"üßÖ"})]})}),e.jsxs("div",{className:"relative mb-8",children:[e.jsx("div",{className:"flex items-center justify-between relative z-10",children:i.map((s,t)=>{const l=b(t);return e.jsxs(d.div,{className:"flex flex-col items-center",animate:{scale:l==="active"?1.1:1},children:[e.jsx(d.div,{className:`w-14 h-14 rounded-full flex items-center justify-center text-2xl ${l==="active"?s.color:l==="processed"||l==="fulfilled"?"bg-dark-600":"bg-dark-800"}`,animate:{boxShadow:l==="active"?"0 0 20px rgba(251, 191, 36, 0.5)":"none"},children:s.icon}),e.jsx("span",{className:`mt-2 text-xs ${l==="active"?"text-amber-400 font-semibold":l==="fulfilled"?"text-green-400":"text-dark-400"}`,children:s.name}),l==="fulfilled"&&e.jsx(d.span,{initial:{scale:0},animate:{scale:1},className:"text-green-400 text-xs",children:"‚úì paid"})]},s.id)})}),e.jsx("div",{className:"absolute top-7 left-7 right-7 flex justify-between z-0",children:i.slice(0,-1).map((s,t)=>{const l=b(t),y=r==="forward"&&t===a||r==="backward"&&t+1===a;return e.jsx(d.div,{className:"flex-1 h-0.5 mx-2",animate:{backgroundColor:y?r==="forward"?"#3b82f6":"#22c55e":l==="processed"||l==="fulfilled"?"#4b5563":"#1f2937"},children:y&&e.jsx(d.div,{className:`h-2 w-2 rounded-full -mt-0.5 ${r==="forward"?"bg-blue-400":"bg-green-400"}`,animate:{x:r==="forward"?["0%","100%"]:["100%","0%"]},transition:{duration:.5,ease:"easeInOut"}})},t)})})]}),e.jsx(S,{mode:"wait",children:e.jsx(d.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"bg-dark-800 rounded-xl p-4 mb-6",children:n===0?e.jsxs("div",{className:"text-center text-dark-400",children:[e.jsx("p",{className:"text-lg",children:'Click "Next Step" to start the payment'}),e.jsx("p",{className:"text-sm mt-2",children:"Watch how the onion packet is constructed and peeled"})]}):r==="forward"?e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-400 font-semibold mb-2",children:[e.jsx("span",{children:"üì¶"}),e.jsx("span",{children:"Forwarding HTLC"})]}),e.jsx("p",{className:"text-dark-300 text-sm",children:a===0?"Sender creates the onion packet with all routing info encrypted in layers.":a===i.length-1?"Final hop receives the payment. Has the preimage to claim it!":`${i[a].name} peels their layer, learns next hop, forwards the HTLC.`}),e.jsx("div",{className:"mt-3 text-xs text-dark-500",children:"Each hop only knows: previous hop, next hop, amount, timelock"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-400 font-semibold mb-2",children:[e.jsx("span",{children:"üîë"}),e.jsx("span",{children:"Returning Preimage"})]}),e.jsx("p",{className:"text-dark-300 text-sm",children:a===i.length-1?"Receiver reveals the preimage to claim the payment.":a===0?"Sender receives preimage - payment complete!":`${i[a].name} receives preimage, updates commitment, passes it back.`}),e.jsx("div",{className:"mt-3 text-xs text-dark-500",children:"The preimage travels backward, settling HTLCs at each hop"})]})},`${n}-${r}`)}),e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:w,disabled:j||n>=o,className:"px-6 py-2 bg-amber-500 hover:bg-amber-400 disabled:bg-dark-700 disabled:text-dark-500 text-dark-900 font-medium rounded-lg transition-colors",children:n>=o?"‚úì Payment Complete":"Next Step ‚Üí"})}),e.jsxs("div",{className:"mt-6 p-4 bg-purple-500/10 border border-purple-500/20 rounded-xl",children:[e.jsx("div",{className:"text-purple-400 text-sm font-semibold mb-1",children:"üîê Sphinx Packet Construction"}),e.jsx("p",{className:"text-dark-300 text-sm",children:"The onion uses Sphinx construction: each layer is encrypted with a shared secret derived via ECDH. The packet stays a constant 1366 bytes - each hop strips their layer and adds padding."})]})]})}function R(){return e.jsxs(H,{sectionId:18,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"BOLT #4: Onion Routing"}),e.jsx(P,{className:"mb-8"}),e.jsx("p",{className:"mb-4",children:'BOLT #4 defines how payment instructions are encrypted using the Sphinx construction. This creates "onion" packets where each hop can only see their own instructions‚Äîproviding strong privacy for the payment route.'}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The Sphinx Construction"}),e.jsx("p",{className:"mb-4",children:"Sphinx is an onion routing protocol that provides:"}),e.jsx(h,{title:"Sphinx Properties",children:e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Per-hop Encryption:"})," Each hop decrypts only their layer"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Unlinkability:"})," Packets look different at each hop"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Constant Size:"})," Packet size doesn't reveal position in route"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Integrity:"})," HMAC prevents tampering"]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Onion Packet Structure"}),e.jsx("p",{className:"mb-4",children:"The onion packet has a fixed structure:"}),e.jsx(m,{title:"Onion Packet Format",children:e.jsxs("table",{className:"w-full text-sm font-mono",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-dark-700",children:[e.jsx("th",{className:"text-left py-2",children:"Field"}),e.jsx("th",{className:"text-left py-2",children:"Size"}),e.jsx("th",{className:"text-left py-2",children:"Description"})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2",children:"version"}),e.jsx("td",{className:"py-2",children:"1 byte"}),e.jsx("td",{className:"py-2",children:"Currently 0"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2",children:"public_key"}),e.jsx("td",{className:"py-2",children:"33 bytes"}),e.jsx("td",{className:"py-2",children:"Ephemeral key for this hop"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2",children:"hop_payloads"}),e.jsx("td",{className:"py-2",children:"1300 bytes"}),e.jsx("td",{className:"py-2",children:"Encrypted per-hop data"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2",children:"hmac"}),e.jsx("td",{className:"py-2",children:"32 bytes"}),e.jsx("td",{className:"py-2",children:"Authentication for current hop"})]})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Shared Secret Generation"}),e.jsx("p",{className:"mb-4",children:"Each hop derives a shared secret using ECDH:"}),e.jsxs(N,{title:"Shared Secret Derivation",children:[e.jsx(g,{children:"\\text{shared\\_secret} = \\text{SHA256}(\\text{ECDH}(\\text{ephemeral\\_key}, \\text{node\\_key}))"}),"Where ECDH produces a curve point that is serialized (compressed) before hashing."]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Key Derivation"}),e.jsx("p",{className:"mb-4",children:"From the shared secret, several keys are derived using HMAC-SHA256:"}),e.jsx(m,{title:"Derived Keys",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-dark-700",children:[e.jsx("th",{className:"text-left py-2",children:"Key"}),e.jsx("th",{className:"text-left py-2",children:"Purpose"})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"rho"}),e.jsx("td",{className:"py-2",children:"ChaCha20 stream for payload obfuscation"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"mu"}),e.jsx("td",{className:"py-2",children:"HMAC key for packet authentication"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"um"}),e.jsx("td",{className:"py-2",children:"HMAC key for error message obfuscation"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-mono",children:"pad"}),e.jsx("td",{className:"py-2",children:"Padding generation for packet filler"})]})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Ephemeral Key Blinding"}),e.jsx("p",{className:"mb-4",children:"The ephemeral key changes at each hop to prevent linking:"}),e.jsxs(N,{title:"Key Blinding",children:[e.jsx(g,{children:"\\text{next\\_ephemeral} = \\text{current\\_ephemeral} \\times \\text{SHA256}(\\text{ephemeral} \\| \\text{shared\\_secret})"}),'This "blinds" the key so observers cannot correlate packets across hops.']}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Hop Payload Format"}),e.jsx("p",{className:"mb-4",children:"Each hop's payload is encoded using TLV format:"}),e.jsx(h,{title:"Hop Payload TLV Fields",children:e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"amt_to_forward (type 2):"})," Amount to forward to next hop"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"outgoing_cltv_value (type 4):"})," CLTV for outgoing HTLC"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"short_channel_id (type 6):"})," Channel to forward on"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"payment_data (type 8):"})," Payment secret + total amount (final hop)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"encrypted_recipient_data (type 10):"})," For blinded paths"]})]})}),e.jsx(m,{title:"Processing a Hop",children:e.jsxs("ol",{className:"list-decimal list-inside space-y-2",children:[e.jsx("li",{children:"Compute shared secret using ECDH with our private key"}),e.jsx("li",{children:"Derive rho and mu keys from shared secret"}),e.jsx("li",{children:"Verify HMAC using mu key"}),e.jsx("li",{children:"Decrypt payload using ChaCha20 with rho key"}),e.jsx("li",{children:"Parse TLV payload to get forwarding instructions"}),e.jsx("li",{children:"Blind the ephemeral key for the next hop"}),e.jsx("li",{children:"Shift hop_payloads left and pad with filler"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Filler Generation"}),e.jsx("p",{className:"mb-4",children:"To maintain constant packet size, filler is generated deterministically:"}),e.jsx(k,{type:"info",title:"Why Filler Matters",children:"As each hop removes their payload, the packet would shrink‚Äîrevealing position in the route. Instead, the sender pre-computes filler that each hop will add, keeping the packet at 1300 bytes throughout."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Error Handling"}),e.jsx("p",{className:"mb-4",children:"Errors are returned using a similar onion structure:"}),e.jsxs(h,{title:"Error Packet",children:["Each hop wraps the error using their shared secret:",e.jsxs("ol",{className:"mt-2 list-decimal list-inside space-y-1",children:[e.jsx("li",{children:"Create HMAC of the error message"}),e.jsx("li",{children:"XOR with a ChaCha20 stream (using um key)"}),e.jsx("li",{children:"Forward back toward the sender"})]}),"The sender can unwrap each layer to find where the error originated."]}),e.jsx(k,{type:"success",title:"Privacy Guarantees",children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Hops don't know total route length"}),e.jsx("li",{children:"Hops don't know if they're first, last, or middle"}),e.jsx("li",{children:"Hops can't correlate incoming and outgoing packets"}),e.jsx("li",{children:"Only the sender can read error messages"})]})})]})}export{R as default};
