import{j as e}from"./vendor-animation-0o8UKZ_1.js";import"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-DFrfwBbR.js";import{L as r,T as a,E as s,D as t,C as i}from"./Callout-DlDYJSPr.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";function p(){return e.jsxs(r,{sectionId:4,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"Feature Negotiation (BOLT #9)"}),e.jsx("p",{className:"mb-4",children:"BOLT #9 defines the feature flag system that allows Lightning implementations to evolve while maintaining backward compatibility. Features are negotiated during connection establishment and announced in node/channel advertisements."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The Bit-Pairing System"}),e.jsx("p",{className:"mb-4",children:"Features use pairs of consecutive bits: even bits indicate mandatory support, odd bits indicate optional support."}),e.jsxs(a,{title:"Feature Bit Pairing",children:["For feature N:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Bit 2N (even):"})," Feature is mandatory - peers MUST support it"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Bit 2N+1 (odd):"})," Feature is optional - nice to have but not required"]})]}),e.jsx("p",{className:"mt-2",children:"Setting the even bit implies the odd bit is also set. Receivers should treat the mandatory bit as superseding the optional one."})]}),e.jsxs(s,{title:"Understanding Feature Pairs",children:[e.jsx("p",{className:"mb-2",children:'Consider "data_loss_protect" at feature pair 0:'}),e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Bit 0 (even):"})," Data loss protection is REQUIRED"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Bit 1 (odd):"})," Data loss protection is OPTIONAL"]})]}),e.jsx("p",{className:"mt-2 text-sm text-dark-300",children:"If a node sets bit 0, peers without this feature cannot connect. If bit 1 is set instead, the feature is used when both peers support it."})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Feature Contexts"}),e.jsx("p",{className:"mb-4",children:"Features are signaled in different contexts, each serving a specific purpose:"}),e.jsxs(t,{title:"Init Features",children:["Announced in the ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"init"})," message during connection establishment. Determines what protocol features the connection will use."]}),e.jsxs(t,{title:"Node Features",children:["Included in ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"node_announcement"})," gossip messages. Advertises a node's general capabilities to the network."]}),e.jsxs(t,{title:"Channel Features",children:["Found in ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"channel_announcement"})," messages. Indicates features supported by a specific channel."]}),e.jsx(t,{title:"Invoice Features",children:"Encoded in BOLT #11 invoices. Specifies what features the payment requires."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Key Features"}),e.jsx(s,{title:"Important Feature Flags",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-dark-700",children:[e.jsx("th",{className:"text-left py-2",children:"Bits"}),e.jsx("th",{className:"text-left py-2",children:"Name"}),e.jsx("th",{className:"text-left py-2",children:"Description"})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"0/1"}),e.jsx("td",{className:"py-2",children:"data_loss_protect"}),e.jsx("td",{className:"py-2",children:"Channel backup/recovery support"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"4/5"}),e.jsx("td",{className:"py-2",children:"upfront_shutdown_script"}),e.jsx("td",{className:"py-2",children:"Pre-commit closing address"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"8/9"}),e.jsx("td",{className:"py-2",children:"gossip_queries"}),e.jsx("td",{className:"py-2",children:"Query-based gossip sync"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"12/13"}),e.jsx("td",{className:"py-2",children:"static_remotekey"}),e.jsx("td",{className:"py-2",children:"Static to_remote key derivation"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"14/15"}),e.jsx("td",{className:"py-2",children:"payment_secret"}),e.jsx("td",{className:"py-2",children:"Payment secret in HTLCs"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"16/17"}),e.jsx("td",{className:"py-2",children:"basic_mpp"}),e.jsx("td",{className:"py-2",children:"Basic multi-part payments"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"20/21"}),e.jsx("td",{className:"py-2",children:"anchor_outputs"}),e.jsx("td",{className:"py-2",children:"Anchor outputs for fee bumping"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"22/23"}),e.jsx("td",{className:"py-2",children:"anchors_zero_fee_htlc_tx"}),e.jsx("td",{className:"py-2",children:"Zero-fee HTLC transactions"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"24/25"}),e.jsx("td",{className:"py-2",children:"route_blinding"}),e.jsx("td",{className:"py-2",children:"Blinded route support"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-mono",children:"44/45"}),e.jsx("td",{className:"py-2",children:"dual_fund"}),e.jsx("td",{className:"py-2",children:"Dual-funded channels (v2)"})]})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Assumed Features"}),e.jsx("p",{className:"mb-4",children:`Some features are so widely adopted that they're considered "assumed"—all implementations are expected to support them regardless of signaling:`}),e.jsxs(i,{type:"info",title:"Assumed Features",children:[e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"data_loss_protect:"})," Essential for channel recovery"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"gossip_queries:"})," Modern gossip synchronization"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"static_remotekey:"})," Simplified key management"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"payment_secret:"})," Required for payment security"]})]}),e.jsx("p",{className:"mt-2",children:"These features don't need to be advertised—peers assume they're present."})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Feature Dependencies"}),e.jsx("p",{className:"mb-4",children:"Some features depend on other features being present. When advertising a feature, all its dependencies must also be advertised."}),e.jsxs(s,{title:"Feature Dependency Example",children:[e.jsxs("p",{className:"mb-2",children:["The ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"basic_mpp"})," feature (multi-part payments) requires ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"payment_secret"}),"."]}),e.jsx("p",{className:"text-sm text-dark-300",children:"If you advertise basic_mpp, you MUST also advertise payment_secret."})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Negotiation Process"}),e.jsx("p",{className:"mb-4",children:"When two nodes connect, they exchange init messages and negotiate features:"}),e.jsx(a,{title:"Feature Negotiation Rules",children:e.jsxs("ol",{className:"list-decimal list-inside space-y-2 mt-2",children:[e.jsx("li",{children:"Both nodes send their feature bitmaps in the init message"}),e.jsx("li",{children:"If either node requires a feature (even bit) the other lacks, disconnect"}),e.jsx("li",{children:"Optional features (odd bits) are used if both peers support them"}),e.jsx("li",{children:"Unknown odd features are ignored; unknown even features cause disconnection"})]})}),e.jsx(s,{title:"Negotiation Example",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Alice's features: 0b00001011"}),e.jsx("p",{className:"text-sm text-dark-300",children:"Bits 0, 1, 3 set (mandatory 0, optional 1 and 3)"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Bob's features: 0b00000111"}),e.jsx("p",{className:"text-sm text-dark-300",children:"Bits 0, 1, 2 set (mandatory 0, optional 1 and 2)"})]}),e.jsxs("div",{className:"pt-2 border-t border-dark-700",children:[e.jsx("p",{className:"font-semibold",children:"Result:"}),e.jsxs("ul",{className:"list-disc list-inside text-sm",children:[e.jsx("li",{children:"Both support mandatory feature 0: ✓"}),e.jsx("li",{children:"Both support optional feature 1: enabled"}),e.jsx("li",{children:"Bob has optional feature 2, Alice doesn't: not used"}),e.jsx("li",{children:"Alice has optional feature 3, Bob doesn't: not used"})]})]})]})}),e.jsx(i,{type:"warning",title:"Graceful Degradation",children:"Nodes should aim to set features as optional (odd bits) whenever possible. This allows connections with older nodes while still benefiting from new features with updated peers."})]})}export{p as default};
