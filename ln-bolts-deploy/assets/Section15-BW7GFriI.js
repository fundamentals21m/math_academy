import{j as e}from"./vendor-animation-0o8UKZ_1.js";import"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-DFrfwBbR.js";import{L as n,D as t,C as s,T as i,E as a}from"./Callout-DlDYJSPr.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";function x(){return e.jsxs(n,{sectionId:15,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"Revoked Transaction Close"}),e.jsx("p",{className:"mb-4",children:"A revoked transaction close occurs when a peer broadcasts an old (revoked) commitment transaction. The honest party can use the revocation key to claim ALL channel funds as a penalty. This is Lightning's primary fraud prevention mechanism."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Detecting Revoked Commitments"}),e.jsx("p",{className:"mb-4",children:"Nodes must monitor the blockchain for any commitment transactions from their channels. If an old commitment appears, it's a breach attempt:"}),e.jsxs(t,{title:"Breach Detection",children:["For each confirmed transaction spending a funding output:",e.jsxs("ol",{className:"mt-2 list-decimal list-inside space-y-1",children:[e.jsx("li",{children:"Identify which channel it belongs to"}),e.jsx("li",{children:"Check if it's the current commitment or an old one"}),e.jsx("li",{children:"If old: retrieve the corresponding per_commitment_secret"}),e.jsx("li",{children:"Construct and broadcast the penalty transaction"})]})]}),e.jsx(s,{type:"danger",title:"Time-Critical Response",children:"The penalty transaction must be broadcast and confirmed BEFORE the cheater's to_self_delay expires. If the cheater spends their to_local output first, those funds are lost forever."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Constructing Penalty Transactions"}),e.jsx("p",{className:"mb-4",children:"With the revocation key, the honest party can spend multiple outputs:"}),e.jsxs(i,{title:"Revocable Outputs",children:["The revocation key can claim:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"to_local:"})," The cheater's main balance"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Offered HTLCs:"})," HTLCs the cheater offered (via revocation path)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Received HTLCs:"})," HTLCs to the cheater (via revocation path)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"HTLC-success/timeout outputs:"})," If cheater used second-stage txs"]})]})]}),e.jsx(a,{title:"Penalty Transaction Structure",children:e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded space-y-1",children:[e.jsx("p",{className:"text-gray-400",children:"// Inputs - all revocable outputs"}),e.jsx("p",{children:"vin[0]: commitment_tx:to_local (using revocation key)"}),e.jsx("p",{children:"vin[1]: commitment_tx:htlc_0 (using revocation key)"}),e.jsx("p",{children:"vin[2]: commitment_tx:htlc_1 (using revocation key)"}),e.jsx("p",{children:"..."}),e.jsx("p",{className:"text-gray-400 mt-2",children:"// Single output to self"}),e.jsx("p",{children:"vout[0]: (total - fee) â†’ honest_party_address"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Spending Revoked Outputs"}),e.jsx("p",{className:"mb-4",children:"Each output type has a revocation spending path:"}),e.jsx(t,{title:"to_local Revocation Spend",children:e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded space-y-1",children:[e.jsx("p",{children:"witness[0]: <signature with revocation_privkey>"}),e.jsx("p",{children:"witness[1]: 0x01 (selects OP_IF branch)"}),e.jsx("p",{children:"witness[2]: <to_local script>"})]})}),e.jsx(t,{title:"HTLC Revocation Spend",children:e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded space-y-1",children:[e.jsx("p",{children:"witness[0]: <revocation_sig>"}),e.jsx("p",{children:"witness[1]: <revocationpubkey>"}),e.jsx("p",{children:"witness[2]: <htlc script>"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Racing Conditions"}),e.jsx("p",{className:"mb-4",children:"After a revoked commitment is broadcast, there's a race between:"}),e.jsx(a,{title:"The Race",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-dark-700",children:[e.jsx("th",{className:"text-left py-2",children:"Cheater's Goal"}),e.jsx("th",{className:"text-left py-2",children:"Honest Party's Goal"})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2",children:"Wait out CSV delay"}),e.jsx("td",{className:"py-2",children:"Broadcast penalty tx"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2",children:"Spend to_local after delay"}),e.jsx("td",{className:"py-2",children:"Claim everything with revocation"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2",children:"Maybe claim HTLCs"}),e.jsx("td",{className:"py-2",children:"Beat them to all outputs"})]})]})]})}),e.jsx(s,{type:"success",title:"Why the Honest Party Wins",children:"The to_self_delay (typically 144-2016 blocks) gives the honest party plenty of time to detect the breach and broadcast penalty transactions. The revocation key allows immediate spending, while the cheater must wait."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Watchtowers"}),e.jsx("p",{className:"mb-4",children:"Watchtowers are third-party services that monitor for breaches when you're offline:"}),e.jsx(t,{title:"Watchtower Operation",children:e.jsxs("ol",{className:"mt-2 list-decimal list-inside space-y-1",children:[e.jsx("li",{children:"You provide encrypted breach remedy data for each commitment"}),e.jsx("li",{children:"Watchtower monitors the blockchain for your channel's funding output"}),e.jsx("li",{children:"If a breach is detected, watchtower decrypts the remedy data"}),e.jsx("li",{children:"Watchtower broadcasts the penalty transaction"}),e.jsx("li",{children:"Watchtower may take a fee; rest goes to your address"})]})}),e.jsxs(a,{title:"Watchtower Data",children:[e.jsx("p",{className:"mb-2 text-sm",children:"For each commitment state, you provide:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-sm",children:[e.jsx("li",{children:"Encrypted blob containing penalty tx or construction info"}),e.jsx("li",{children:'A "hint" derived from the commitment transaction'}),e.jsx("li",{children:"If the hint appears on-chain, decrypt and broadcast"})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Penalty Transaction Fees"}),e.jsx("p",{className:"mb-4",children:"Penalty transactions should use high fees to ensure quick confirmation:"}),e.jsx(i,{title:"Fee Strategy",children:e.jsxs("ul",{className:"list-disc list-inside space-y-2 mt-2",children:[e.jsx("li",{children:"Use the highest reasonable fee rate (this is an emergency!)"}),e.jsx("li",{children:"Consider batching all revocable outputs into one transaction"}),e.jsx("li",{children:"If using anchors, CPFP can boost the commitment transaction too"}),e.jsx("li",{children:"Leave enough value in the penalty transaction for fees"})]})}),e.jsx(s,{type:"warning",title:"Incomplete Penalty",children:"If you miss claiming some outputs (e.g., an HTLC you didn't notice), the cheater might still get that portion. Always claim ALL revocable outputs in your penalty transaction."})]})}export{x as default};
