import{j as e,m as b,A as B}from"./vendor-animation-0o8UKZ_1.js";import{r as m}from"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-BbBpzejs.js";import{L as A}from"./LessonLayout-Bq4tucEw.js";import{D as c,C as x,T as u,E as g}from"./Callout-BvJhqaqq.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";const j={aliceBalance:5e5,bobBalance:5e5,htlcs:[],commitmentNumber:0,pendingChanges:[]};function S({className:f=""}){const[i,o]=m.useState(j),[h,r]=m.useState([]),[a,l]=m.useState("idle"),[y,p]=m.useState(1),N=()=>{if(a!=="idle"||i.aliceBalance<5e4)return;const t={id:y,amount:5e4,state:"pending",direction:"offered"};o(s=>({...s,htlcs:[...s.htlcs,t],pendingChanges:[...s.pendingChanges,`Add HTLC #${t.id}`]})),r(s=>[...s,{type:"update_add_htlc",from:"alice",description:`Alice offers HTLC #${t.id} for ${t.amount.toLocaleString()} sats`}]),p(s=>s+1),l("adding")},_=()=>{a!=="adding"&&a!=="idle"||i.htlcs.filter(s=>s.state==="pending").length===0&&i.pendingChanges.length===0||(r(s=>[...s,{type:"commitment_signed",from:"alice",description:"Alice signs new commitment including all pending changes"}]),l("committing"))},k=()=>{a==="committing"&&(o(t=>({...t,htlcs:t.htlcs.map(s=>s.state==="pending"?{...s,state:"committed"}:s),aliceBalance:t.aliceBalance-t.htlcs.filter(s=>s.state==="pending").reduce((s,n)=>s+n.amount,0),commitmentNumber:t.commitmentNumber+1,pendingChanges:[]})),r(t=>[...t,{type:"revoke_and_ack",from:"bob",description:`Bob revokes old state #${i.commitmentNumber} and acknowledges new commitment`}]),l("revoking"),setTimeout(()=>l("idle"),500))},v=t=>{if(a!=="idle")return;const s=i.htlcs.find(n=>n.id===t&&n.state==="committed");s&&(o(n=>({...n,htlcs:n.htlcs.map(d=>d.id===t?{...d,state:"fulfilled"}:d),bobBalance:n.bobBalance+s.amount,pendingChanges:[...n.pendingChanges,`Fulfill HTLC #${t}`]})),r(n=>[...n,{type:"update_fulfill_htlc",from:"bob",description:`Bob reveals preimage for HTLC #${t}, claiming ${s.amount.toLocaleString()} sats`}]),l("fulfilling"),setTimeout(()=>l("idle"),500))},C=t=>{if(a!=="idle")return;const s=i.htlcs.find(n=>n.id===t&&n.state==="committed");s&&(o(n=>({...n,htlcs:n.htlcs.map(d=>d.id===t?{...d,state:"failed"}:d),aliceBalance:n.aliceBalance+s.amount,pendingChanges:[...n.pendingChanges,`Fail HTLC #${t}`]})),r(n=>[...n,{type:"update_fail_htlc",from:"bob",description:`Bob fails HTLC #${t}, returning ${s.amount.toLocaleString()} sats to Alice`}]))},T=()=>{o(j),r([]),l("idle"),p(1)},w=i.htlcs.filter(t=>t.state==="committed"),L=i.htlcs.filter(t=>t.state==="pending"),H=w.reduce((t,s)=>t+s.amount,0);return e.jsxs("div",{className:`bg-dark-900 rounded-2xl p-6 ${f}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-dark-100",children:"HTLC Flow Simulator"}),e.jsx("button",{onClick:T,className:"px-3 py-1 text-sm bg-dark-700 hover:bg-dark-600 text-dark-300 rounded-lg transition-colors",children:"Reset"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-xl p-4",children:[e.jsxs("div",{className:"text-center mb-3",children:[e.jsx("div",{className:"text-2xl mb-1",children:"üë§"}),e.jsx("span",{className:"text-blue-400 font-semibold",children:"Alice"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-dark-100",children:i.aliceBalance.toLocaleString()}),e.jsx("div",{className:"text-dark-500 text-xs",children:"sats"})]})]}),e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4",children:[e.jsx("div",{className:"text-center text-dark-400 text-xs mb-2",children:"Channel State"}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-lg font-bold text-amber-400",children:["#",i.commitmentNumber]}),e.jsx("div",{className:"text-dark-500 text-xs",children:"commitment"})]}),e.jsxs("div",{className:"mt-3 text-center",children:[e.jsxs("div",{className:"text-sm text-dark-300",children:[H.toLocaleString()," sats"]}),e.jsx("div",{className:"text-dark-500 text-xs",children:"in-flight"})]})]}),e.jsxs("div",{className:"bg-green-500/10 border border-green-500/30 rounded-xl p-4",children:[e.jsxs("div",{className:"text-center mb-3",children:[e.jsx("div",{className:"text-2xl mb-1",children:"üñ•Ô∏è"}),e.jsx("span",{className:"text-green-400 font-semibold",children:"Bob"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-dark-100",children:i.bobBalance.toLocaleString()}),e.jsx("div",{className:"text-dark-500 text-xs",children:"sats"})]})]})]}),e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-dark-300 font-semibold",children:"Active HTLCs"}),e.jsx("button",{onClick:N,disabled:a!=="idle"||i.aliceBalance<5e4,className:"px-3 py-1 text-xs bg-blue-500/20 hover:bg-blue-500/30 disabled:opacity-50 text-blue-400 rounded-lg transition-colors",children:"+ Add HTLC (50k sats)"})]}),e.jsx("div",{className:"space-y-2",children:i.htlcs.length===0?e.jsx("div",{className:"text-dark-500 text-sm text-center py-4",children:"No active HTLCs. Add one to start the flow."}):i.htlcs.map(t=>e.jsxs(b.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},className:`flex items-center justify-between p-3 rounded-lg ${t.state==="pending"?"bg-amber-500/20":t.state==="committed"?"bg-purple-500/20":t.state==="fulfilled"?"bg-green-500/20":"bg-red-500/20"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:`text-sm font-mono ${t.state==="pending"?"text-amber-400":t.state==="committed"?"text-purple-400":t.state==="fulfilled"?"text-green-400":"text-red-400"}`,children:["HTLC #",t.id]}),e.jsxs("span",{className:"text-dark-300 text-sm",children:[t.amount.toLocaleString()," sats"]}),e.jsx("span",{className:`px-2 py-0.5 rounded text-xs ${t.state==="pending"?"bg-amber-500/30 text-amber-300":t.state==="committed"?"bg-purple-500/30 text-purple-300":t.state==="fulfilled"?"bg-green-500/30 text-green-300":"bg-red-500/30 text-red-300"}`,children:t.state})]}),t.state==="committed"&&a==="idle"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>v(t.id),className:"px-2 py-1 text-xs bg-green-500/30 hover:bg-green-500/40 text-green-400 rounded transition-colors",children:"Fulfill"}),e.jsx("button",{onClick:()=>C(t.id),className:"px-2 py-1 text-xs bg-red-500/30 hover:bg-red-500/40 text-red-400 rounded transition-colors",children:"Fail"})]})]},t.id))})]}),e.jsxs("div",{className:"flex justify-center gap-4 mb-6",children:[e.jsx("button",{onClick:_,disabled:L.length===0&&i.pendingChanges.length===0,className:"px-4 py-2 bg-purple-500 hover:bg-purple-400 disabled:bg-dark-700 disabled:text-dark-500 text-white font-medium rounded-lg transition-colors",children:"Sign Commitment"}),e.jsx("button",{onClick:k,disabled:a!=="committing",className:"px-4 py-2 bg-amber-500 hover:bg-amber-400 disabled:bg-dark-700 disabled:text-dark-500 text-dark-900 font-medium rounded-lg transition-colors",children:"Revoke & Ack"})]}),e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4",children:[e.jsx("h4",{className:"text-dark-300 font-semibold mb-3",children:"Message Log"}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:e.jsx(B,{children:h.length===0?e.jsx("div",{className:"text-dark-500 text-sm text-center py-2",children:"Messages will appear here..."}):h.slice(-10).map((t,s)=>e.jsxs(b.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`flex items-start gap-2 p-2 rounded ${t.from==="alice"?"bg-blue-500/10":"bg-green-500/10"}`,children:[e.jsx("span",{className:`text-xs font-mono px-1.5 py-0.5 rounded ${t.type==="update_add_htlc"?"bg-amber-500/30 text-amber-400":t.type==="commitment_signed"?"bg-purple-500/30 text-purple-400":t.type==="revoke_and_ack"?"bg-blue-500/30 text-blue-400":t.type==="update_fulfill_htlc"?"bg-green-500/30 text-green-400":"bg-red-500/30 text-red-400"}`,children:t.type}),e.jsx("span",{className:"text-dark-300 text-sm flex-1",children:t.description})]},s))})})]}),e.jsxs("div",{className:"mt-6 p-4 bg-purple-500/10 border border-purple-500/20 rounded-xl",children:[e.jsx("div",{className:"text-purple-400 text-sm font-semibold mb-1",children:"üîÑ Update Protocol"}),e.jsxs("p",{className:"text-dark-300 text-sm",children:["1. ",e.jsx("strong",{children:"update_add_htlc"}),": Propose HTLC ‚Üí 2. ",e.jsx("strong",{children:"commitment_signed"}),": Sign new state ‚Üí 3. ",e.jsx("strong",{children:"revoke_and_ack"}),": Revoke old, ack new ‚Üí 4. ",e.jsx("strong",{children:"update_fulfill/fail_htlc"}),": Resolve HTLC"]})]})]})}function D(){return e.jsxs(A,{sectionId:7,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"Channel Operations"}),e.jsx(S,{className:"mb-8"}),e.jsx("p",{className:"mb-4",children:'Once a channel is established and both parties have exchanged channel_ready, the channel enters "normal operation." This section covers how HTLCs are added, removed, and how commitment transactions are updated.'}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Adding HTLCs"}),e.jsxs(c,{title:"update_add_htlc (type 128)",children:["Offers a new HTLC to the remote peer:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"id: 8 bytes (unique per channel, increments from 0)"}),e.jsx("p",{children:"amount_msat: 8 bytes (payment amount in millisatoshis)"}),e.jsx("p",{children:"payment_hash: 32 bytes"}),e.jsx("p",{children:"cltv_expiry: 4 bytes (absolute block height timeout)"}),e.jsx("p",{children:"onion_routing_packet: 1366 bytes"})]})]}),e.jsx("p",{className:"mt-4 mb-4",children:"The onion_routing_packet contains encrypted instructions for the next hop (or the final recipient). This is the BOLT #4 Sphinx packet."}),e.jsxs(x,{type:"warning",title:"HTLC Limits",children:["Each peer specifies limits during channel setup:",e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"max_accepted_htlcs:"})," Maximum concurrent HTLCs"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"max_htlc_value_in_flight_msat:"})," Max total pending value"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"htlc_minimum_msat:"})," Minimum HTLC value"]})]}),"Violating these limits results in a channel error."]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Removing HTLCs"}),e.jsx("p",{className:"mb-4",children:"HTLCs can be removed in three ways: fulfilled (payment succeeded), failed (payment failed), or failed with malformed onion:"}),e.jsxs(c,{title:"update_fulfill_htlc (type 130)",children:["Fulfills an HTLC by revealing the preimage:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"id: 8 bytes (matches the update_add_htlc)"}),e.jsx("p",{children:"payment_preimage: 32 bytes"})]})]}),e.jsxs(c,{title:"update_fail_htlc (type 131)",children:["Fails an HTLC with an encrypted reason:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"id: 8 bytes"}),e.jsx("p",{children:"reason: variable (encrypted error message)"})]})]}),e.jsxs(c,{title:"update_fail_malformed_htlc (type 135)",children:["Fails an HTLC due to unparseable onion packet:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"id: 8 bytes"}),e.jsx("p",{children:"sha256_of_onion: 32 bytes"}),e.jsx("p",{children:"failure_code: 2 bytes"})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Commitment Update Flow"}),e.jsx("p",{className:"mb-4",children:"After sending one or more update messages, the sender must eventually commit them:"}),e.jsx(u,{title:"The Commitment Dance",children:e.jsxs("ol",{className:"list-decimal list-inside space-y-2 mt-2",children:[e.jsx("li",{children:"Alice sends update_add_htlc (and possibly other updates)"}),e.jsx("li",{children:"Alice sends commitment_signed with signatures for Bob's new commitment"}),e.jsx("li",{children:"Bob verifies and stores the new commitment"}),e.jsx("li",{children:"Bob sends revoke_and_ack with his old commitment's revocation key"}),e.jsx("li",{children:"Alice can now discard Bob's old commitment state"}),e.jsx("li",{children:"Bob sends commitment_signed for Alice's new commitment"}),e.jsx("li",{children:"Alice sends revoke_and_ack"})]})}),e.jsx(g,{title:"Commitment Update Sequence",children:e.jsxs("div",{className:"font-mono text-sm space-y-2",children:[e.jsx("p",{className:"text-blue-400",children:"Alice ‚Üí Bob: update_add_htlc"}),e.jsx("p",{className:"text-blue-400",children:"Alice ‚Üí Bob: commitment_signed"}),e.jsx("p",{className:"text-green-400",children:"Bob ‚Üí Alice: revoke_and_ack"}),e.jsx("p",{className:"text-green-400",children:"Bob ‚Üí Alice: commitment_signed"}),e.jsx("p",{className:"text-blue-400",children:"Alice ‚Üí Bob: revoke_and_ack"}),e.jsx("p",{className:"text-gray-400",children:"--- HTLC is now irrevocably committed ---"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Commitment Messages"}),e.jsxs(c,{title:"commitment_signed (type 132)",children:["Provides signatures for the remote peer's next commitment transaction:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"signature: 64 bytes (for the commitment tx)"}),e.jsx("p",{children:"num_htlcs: 2 bytes"}),e.jsx("p",{children:"htlc_signature: 64 bytes each (for HTLC transactions)"})]})]}),e.jsxs(c,{title:"revoke_and_ack (type 133)",children:["Revokes the previous commitment and acknowledges the new one:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"per_commitment_secret: 32 bytes (reveals old commitment's secret)"}),e.jsx("p",{children:"next_per_commitment_point: 33 bytes (for N+2 commitment)"})]})]}),e.jsx(x,{type:"info",title:"Why Revocation Matters",children:"The per_commitment_secret allows the counterparty to construct the revocation key for the old commitment. If the revoked commitment is ever broadcast, the counterparty can claim ALL funds using this key."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Fee Updates"}),e.jsx("p",{className:"mb-4",children:"The funder (channel initiator) can propose fee changes for commitment transactions:"}),e.jsxs(c,{title:"update_fee (type 134)",children:["Proposes a new fee rate for commitment transactions:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"feerate_per_kw: 4 bytes (satoshis per 1000 weight units)"})]})]}),e.jsx(x,{type:"warning",title:"Fee Update Rules",children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Only the funder can send update_fee"}),e.jsx("li",{children:"Fee changes are applied to BOTH commitment transactions"}),e.jsx("li",{children:"The fundee can reject unreasonable fee rates"}),e.jsx("li",{children:"Fee must be paid from the funder's balance"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Channel Reserve"}),e.jsx("p",{className:"mb-4",children:'Each peer must maintain a minimum balance (channel_reserve) to ensure they have "skin in the game":'}),e.jsx(u,{title:"Channel Reserve Purpose",children:"The channel reserve ensures each party has something to lose if they broadcast a revoked commitment. A node cannot send funds that would reduce their balance below the remote peer's specified channel_reserve_satoshis."}),e.jsxs(g,{title:"Channel Reserve Example",children:[e.jsx("p",{className:"mb-2",children:"In a 1 BTC channel with 1% reserves:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Alice must keep at least 0.01 BTC"}),e.jsx("li",{children:"Bob must keep at least 0.01 BTC"}),e.jsx("li",{children:"Maximum transferable: 0.98 BTC in either direction"})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Concurrent Updates"}),e.jsx("p",{className:"mb-4",children:"Both peers can send updates simultaneously. The protocol handles this through careful state management‚Äîeach peer tracks both their proposed state and the acknowledged state."}),e.jsxs(x,{type:"success",title:"State Tracking",children:["Each peer maintains:",e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Local commitment (what we'd broadcast if needed)"}),e.jsx("li",{children:"Remote commitment (what peer would broadcast)"}),e.jsx("li",{children:"Proposed changes not yet committed"}),e.jsx("li",{children:"Revocation keys for all old states"})]})]})]})}export{D as default};
