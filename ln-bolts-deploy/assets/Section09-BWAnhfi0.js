import{j as e}from"./vendor-animation-0o8UKZ_1.js";import"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-BbBpzejs.js";import{L as r}from"./LessonLayout-Bq4tucEw.js";import{M as a}from"./MathBlock-BfkVbDlQ.js";import{D as s,T as t,E as n,C as i}from"./Callout-BvJhqaqq.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";function f(){return e.jsxs(r,{sectionId:9,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"BOLT #3: Funding Transactions"}),e.jsx("p",{className:"mb-4",children:"BOLT #3 specifies the exact Bitcoin transaction and script formats used in Lightning channels. This section covers the funding transactionâ€”the on-chain transaction that creates and secures the channel."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Funding Output Structure"}),e.jsx("p",{className:"mb-4",children:"The funding transaction creates a 2-of-2 multisig output that both channel parties must sign to spend. This is the foundation of all channel security."}),e.jsxs(s,{title:"Funding Output Script",children:["A Pay-to-Witness-Script-Hash (P2WSH) output with a 2-of-2 multisig witness script:",e.jsx("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2",children:e.jsx("p",{children:"OP_2 <pubkey1> <pubkey2> OP_2 OP_CHECKMULTISIG"})}),e.jsx("p",{className:"mt-2",children:"Where pubkey1 and pubkey2 are the funding pubkeys from open_channel and accept_channel, ordered lexicographically (smaller pubkey first)."})]}),e.jsx(t,{title:"Lexicographic Key Ordering",children:"To ensure both parties derive the same script hash, public keys are sorted lexicographically (comparing as unsigned byte arrays). This creates a canonical ordering regardless of who is funder vs fundee."}),e.jsxs(n,{title:"Funding Script Construction",children:[e.jsx("p",{className:"mb-2 text-sm",children:"Given funding pubkeys:"}),e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-2 rounded space-y-1",children:[e.jsx("p",{children:"Alice: 02a1b2c3... (compresses to smaller value)"}),e.jsx("p",{children:"Bob: 03d4e5f6... (compresses to larger value)"})]}),e.jsx("p",{className:"mt-2 text-sm",children:"The witness script is always:"}),e.jsx("div",{className:"font-mono text-xs bg-dark-800 p-2 rounded mt-1",children:"OP_2 02a1b2c3... 03d4e5f6... OP_2 OP_CHECKMULTISIG"}),e.jsx("p",{className:"mt-2 text-sm",children:"Regardless of who initiated the channel."})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Funding Transaction Format"}),e.jsx("p",{className:"mb-4",children:"The funding transaction itself follows standard Bitcoin transaction rules:"}),e.jsx(s,{title:"Funding Transaction Requirements",children:e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Version:"})," 2 (for sequence-based CSV support)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Inputs:"})," Standard UTXOs from the funder"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Funding Output:"})," P2WSH with the 2-of-2 multisig"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Change Output:"})," Optional, returns excess to funder"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Locktime:"})," Typically 0 (or current block height)"]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Computing the Funding Output Hash"}),e.jsx("p",{className:"mb-4",children:"The funding output uses P2WSH, which requires computing a script hash:"}),e.jsx(t,{title:"P2WSH Address Derivation",children:e.jsxs("ol",{className:"list-decimal list-inside space-y-2 mt-2",children:[e.jsx("li",{children:"Construct the witness script (2-of-2 multisig)"}),e.jsx("li",{children:"Compute SHA256 hash of the witness script"}),e.jsx("li",{children:"Create scriptPubKey: OP_0 <32-byte hash>"}),e.jsx("li",{children:"This is the funding output's locking script"})]})}),e.jsxs(n,{title:"Spending the Funding Output",children:[e.jsx("p",{className:"mb-2 text-sm",children:"To spend, the witness stack must contain:"}),e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-2 rounded space-y-1",children:[e.jsx("p",{children:"witness[0]: (empty for OP_CHECKMULTISIG bug)"}),e.jsx("p",{children:"witness[1]: <signature from pubkey1>"}),e.jsx("p",{children:"witness[2]: <signature from pubkey2>"}),e.jsx("p",{children:"witness[3]: <witness script (the 2-of-2 multisig)>"})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Channel ID Derivation"}),e.jsx("p",{className:"mb-4",children:"Once the funding transaction is known, the permanent channel ID can be computed:"}),e.jsxs(s,{title:"Channel ID Calculation",children:[e.jsx(a,{children:"\\text{channel\\_id} = \\text{funding\\_txid} \\oplus \\text{output\\_index}"}),e.jsx("p",{className:"mt-2",children:"The output index is left-padded to 32 bytes before XOR. This creates a unique identifier tied to the specific funding UTXO."})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Confirmation Requirements"}),e.jsx("p",{className:"mb-4",children:"The funding transaction must be confirmed before the channel is fully operational:"}),e.jsx(n,{title:"Confirmation Flow",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-dark-700",children:[e.jsx("th",{className:"text-left py-2",children:"Confirmations"}),e.jsx("th",{className:"text-left py-2",children:"Channel State"})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"0"}),e.jsx("td",{className:"py-2",children:"Waiting (or zero-conf if supported)"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"1 to minimum_depth-1"}),e.jsx("td",{className:"py-2",children:"Confirming"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"minimum_depth"}),e.jsx("td",{className:"py-2",children:"Ready (channel_ready exchanged)"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-mono",children:"6+"}),e.jsx("td",{className:"py-2",children:"Can be announced (BOLT #7)"})]})]})]})}),e.jsxs(i,{type:"warning",title:"Reorg Protection",children:["If a blockchain reorganization occurs and the funding transaction is no longer confirmed, nodes must:",e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Stop using the channel immediately"}),e.jsx("li",{children:"Wait for re-confirmation before resuming"}),e.jsx("li",{children:"Handle the case where the funding tx is double-spent"})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Funding Transaction Security"}),e.jsx("p",{className:"mb-4",children:"Several security considerations apply to the funding transaction:"}),e.jsx(t,{title:"Security Properties",children:e.jsxs("ul",{className:"list-disc list-inside space-y-2 mt-2",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"No Preimage Attack:"})," The funding script hash is computed before the transaction is broadcast, preventing script substitution."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"2-of-2 Requirement:"})," Neither party can unilaterally spend the funding output (without broadcasting a commitment transaction)."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Confirmation Finality:"})," After sufficient confirmations, the funding UTXO is considered secure against reorganizations."]})]})}),e.jsxs(i,{type:"info",title:"Anchor Outputs",children:["Channels with ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"option_anchors"})," don't change the funding transaction itself. Anchors appear in commitment transactions, not the funding transaction."]})]})}export{f as default};
