import{j as e}from"./vendor-animation-0o8UKZ_1.js";import"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-DFrfwBbR.js";import{L as l,D as s,C as t,T as n,E as i}from"./Callout-DlDYJSPr.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";function p(){return e.jsxs(l,{sectionId:8,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"Channel Closure"}),e.jsx("p",{className:"mb-4",children:"Channels can be closed cooperatively (mutual close) or non-cooperatively (unilateral close). This section covers the cooperative closing flow defined in BOLT #2."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Initiating Closure"}),e.jsxs(s,{title:"shutdown (type 38)",children:["Signals intent to close the channel. After this, no new HTLCs can be added:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"scriptpubkey: variable (where to send funds)"})]})]}),e.jsx("p",{className:"mt-4 mb-4",children:"Either peer can initiate shutdown. Once both peers have sent shutdown:"}),e.jsxs("ul",{className:"list-disc list-inside mb-6 space-y-2 text-dark-200",children:[e.jsx("li",{children:"No new HTLCs can be added (update_add_htlc is forbidden)"}),e.jsx("li",{children:"Existing HTLCs must be resolved (fulfilled or failed)"}),e.jsx("li",{children:"After all HTLCs are cleared, the closing negotiation begins"})]}),e.jsxs(t,{type:"info",title:"Upfront Shutdown Script",children:["With the ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"option_upfront_shutdown_script"}),"feature, peers can commit to a closing address during channel opening. This prevents an attacker from redirecting funds after compromising a node."]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Simple Close Protocol"}),e.jsxs("p",{className:"mb-4",children:["The modern closing protocol (",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"option_simple_close"}),") is straightforward: each party creates and signs their own closing transaction."]}),e.jsxs(s,{title:"closing_complete (type 40)",children:["Sent by the initiator with their proposed closing transaction:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"fee_satoshis: 8 bytes (fee for the closer's tx)"}),e.jsx("p",{children:"signature: 64 bytes"}),e.jsx("p",{children:"tlvs: optional (including closer_script)"})]})]}),e.jsxs(s,{title:"closing_sig (type 41)",children:["Response with the counterparty's signature:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"signature: 64 bytes"}),e.jsx("p",{children:"tlvs: optional (including closer_script)"})]})]}),e.jsx(n,{title:"Simple Close Properties",children:e.jsxs("ul",{className:"list-disc list-inside space-y-2 mt-2",children:[e.jsx("li",{children:"Each party pays their own transaction fees"}),e.jsx("li",{children:"The closing initiator goes first with closing_complete"}),e.jsx("li",{children:"Multiple rounds are allowed to adjust fees or addresses"}),e.jsx("li",{children:"Either party can broadcast once they have both signatures"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Legacy Closing Protocol"}),e.jsx("p",{className:"mb-4",children:"The older protocol uses fee negotiation between peers:"}),e.jsxs(s,{title:"closing_signed (type 39)",children:["Proposes a closing transaction with a specific fee:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"fee_satoshis: 8 bytes"}),e.jsx("p",{children:"signature: 64 bytes"}),e.jsx("p",{children:"fee_range: optional TLV (min/max acceptable fees)"})]})]}),e.jsx(i,{title:"Legacy Fee Negotiation",children:e.jsxs("div",{className:"font-mono text-sm space-y-2",children:[e.jsx("p",{className:"text-blue-400",children:"Funder → Fundee: closing_signed (fee=1000 sats)"}),e.jsx("p",{className:"text-green-400",children:"Fundee → Funder: closing_signed (fee=500 sats)"}),e.jsx("p",{className:"text-blue-400",children:"Funder → Fundee: closing_signed (fee=750 sats)"}),e.jsx("p",{className:"text-green-400",children:"Fundee → Funder: closing_signed (fee=750 sats)"}),e.jsx("p",{className:"text-gray-400",children:"--- Agreement reached, channel closed ---"})]})}),e.jsx(t,{type:"warning",title:"Fee Negotiation Rules",children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"The funder proposes the initial fee"}),e.jsx("li",{children:"Each subsequent proposal must be closer to the peer's last proposal"}),e.jsx("li",{children:"Agreement is reached when both propose the same fee"}),e.jsx("li",{children:"Fee is deducted from the funder's balance"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Closing Transaction Structure"}),e.jsx("p",{className:"mb-4",children:"The closing transaction is simple compared to commitment transactions:"}),e.jsx(n,{title:"Closing Transaction Format",children:e.jsxs("ul",{className:"list-disc list-inside space-y-2 mt-2",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Version:"})," 2"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Input:"})," The funding output (2-of-2 multisig)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Outputs:"})," One for each party with balance above dust"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Locktime:"})," 0"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"No HTLCs:"})," All must be resolved before closing"]})]})}),e.jsx(i,{title:"Closing Transaction Example",children:e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded space-y-2",children:[e.jsx("p",{className:"text-gray-400",children:"// Input"}),e.jsx("p",{children:"vin[0]: funding_txid:funding_output_index"}),e.jsx("p",{className:"text-gray-400 mt-2",children:"// Outputs (ordered by value, then script)"}),e.jsx("p",{children:"vout[0]: 0.6 BTC → Alice's scriptpubkey"}),e.jsx("p",{children:"vout[1]: 0.3999 BTC → Bob's scriptpubkey"}),e.jsx("p",{className:"text-gray-400",children:"// Fee: 0.0001 BTC (from funder)"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"When to Use Each Method"}),e.jsx("p",{className:"mb-4",children:"The closing method depends on peer availability and cooperation:"}),e.jsx(i,{title:"Closing Method Selection",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-dark-700",children:[e.jsx("th",{className:"text-left py-2",children:"Scenario"}),e.jsx("th",{className:"text-left py-2",children:"Method"})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2",children:"Both peers online, cooperative"}),e.jsx("td",{className:"py-2",children:"Mutual close (simple or legacy)"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2",children:"Peer unresponsive"}),e.jsx("td",{className:"py-2",children:"Unilateral close (BOLT #5)"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2",children:"Dispute over state"}),e.jsx("td",{className:"py-2",children:"Unilateral close (BOLT #5)"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2",children:"Peer broadcast old state"}),e.jsx("td",{className:"py-2",children:"Penalty transaction (BOLT #5)"})]})]})]})}),e.jsx(t,{type:"success",title:"Benefits of Mutual Close",children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Lower fees (simpler transaction)"}),e.jsx("li",{children:"Immediate access to funds (no timelock)"}),e.jsx("li",{children:"Better privacy (looks like regular transaction)"}),e.jsx("li",{children:"Faster confirmation (no CSV delays)"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Reconnection During Close"}),e.jsx("p",{className:"mb-4",children:"If peers disconnect during the closing process:"}),e.jsxs("ul",{className:"list-disc list-inside mb-6 space-y-2 text-dark-200",children:[e.jsx("li",{children:"Upon reconnection, use channel_reestablish to sync state"}),e.jsx("li",{children:"If shutdown was sent, continue the closing process"}),e.jsx("li",{children:"If the closing transaction was signed, either can broadcast"}),e.jsx("li",{children:"Partially completed negotiations resume from last state"})]})]})}export{p as default};
