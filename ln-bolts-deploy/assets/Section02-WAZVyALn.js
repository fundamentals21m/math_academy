import{j as e,m as c,A as N}from"./vendor-animation-0o8UKZ_1.js";import{r as d}from"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-BbBpzejs.js";import{L as v}from"./LessonLayout-Bq4tucEw.js";import{C as o,D as a,E as h,T as m}from"./Callout-BvJhqaqq.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";const j={act:0,step:0,initiatorEphemeral:"",responderEphemeral:"",sharedSecrets:[],messages:[],chainingKey:"ckâ‚€",handshakeHash:"hâ‚€"},g=()=>{const l="0123456789abcdef";return Array.from({length:8},()=>l[Math.floor(Math.random()*16)]).join("")+"..."};function w({className:l=""}){const[s,p]=d.useState(j),[x,y]=d.useState(!1),n=d.useMemo(()=>[{act:1,title:"Generate Ephemeral Key",description:"Initiator generates ephemeral key pair (e, e.pub)",actor:"initiator"},{act:1,title:"ECDH with Responder Static",description:"Compute es = ECDH(e, rs) using responder's known static key",actor:"initiator"},{act:1,title:"Derive Encryption Key",description:"Use HKDF to derive encryption key from shared secret",actor:"initiator"},{act:1,title:"Send Act One",description:"Send: version (1B) + e.pub (33B) + tag (16B) = 50 bytes",actor:"initiator"},{act:2,title:"Generate Ephemeral Key",description:"Responder generates ephemeral key pair (e, e.pub)",actor:"responder"},{act:2,title:"ECDH: ee",description:"Compute ee = ECDH(e, re) with initiator's ephemeral",actor:"responder"},{act:2,title:"ECDH: es",description:"Compute es = ECDH(s, re) using own static key",actor:"responder"},{act:2,title:"Send Act Two",description:"Send: version (1B) + e.pub (33B) + tag (16B) = 50 bytes",actor:"responder"},{act:3,title:"ECDH: ee",description:"Compute ee = ECDH(e, re) with responder's ephemeral",actor:"initiator"},{act:3,title:"ECDH: se",description:"Compute se = ECDH(s, re) using own static key",actor:"initiator"},{act:3,title:"Encrypt Static Key",description:"Encrypt initiator's static public key",actor:"initiator"},{act:3,title:"Send Act Three",description:"Send: version (1B) + encrypted key (49B) + tag (16B) = 66 bytes",actor:"initiator"},{act:4,title:"Handshake Complete",description:"Both parties derive symmetric send/receive keys",actor:"both"}],[]),r=n[s.step]||n[0],b=async()=>{if(x||s.step>=n.length)return;y(!0);const t=n[s.step],i={...s};t.act===1&&t.title.includes("Generate")?i.initiatorEphemeral=g():t.act===1&&t.title.includes("ECDH")?i.sharedSecrets=[...s.sharedSecrets,"esâ‚"]:t.act===1&&t.title.includes("Send")?i.messages=[...s.messages,{from:"Initiator",to:"Responder",content:"Act One",bytes:50}]:t.act===2&&t.title.includes("Generate")?i.responderEphemeral=g():t.act===2&&t.title.includes("ee")?i.sharedSecrets=[...s.sharedSecrets,"ee"]:t.act===2&&t.title.includes("es")?i.sharedSecrets=[...s.sharedSecrets,"esâ‚‚"]:t.act===2&&t.title.includes("Send")?i.messages=[...s.messages,{from:"Responder",to:"Initiator",content:"Act Two",bytes:50}]:t.act===3&&t.title.includes("Send")&&(i.messages=[...s.messages,{from:"Initiator",to:"Responder",content:"Act Three",bytes:66}]),i.act=t.act,i.step=s.step+1,i.chainingKey=`ck${s.step+1}`,i.handshakeHash=`h${s.step+1}`,await new Promise(f=>setTimeout(f,300)),p(i),y(!1)},u=()=>{p(j)},k=s.step/n.length*100;return e.jsxs("div",{className:`bg-dark-900 rounded-2xl p-6 ${l}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-dark-100",children:"Noise_XK Handshake Simulator"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:u,className:"px-3 py-1 text-sm bg-dark-700 hover:bg-dark-600 text-dark-300 rounded-lg transition-colors",children:"Reset"}),e.jsx("button",{onClick:b,disabled:x||s.step>=n.length,className:"px-4 py-1 text-sm bg-amber-500 hover:bg-amber-400 disabled:bg-dark-700 disabled:text-dark-500 text-dark-900 font-medium rounded-lg transition-colors",children:s.step>=n.length?"Complete":"Next Step"})]})]}),e.jsx("div",{className:"h-2 bg-dark-800 rounded-full mb-6 overflow-hidden",children:e.jsx(c.div,{className:"h-full bg-gradient-to-r from-amber-500 to-amber-400",initial:{width:0},animate:{width:`${k}%`},transition:{duration:.3}})}),e.jsx(N,{mode:"wait",children:e.jsxs(c.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"bg-dark-800 rounded-xl p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("span",{className:`px-2 py-1 text-xs font-bold rounded ${r.act===1?"bg-blue-500/20 text-blue-400":r.act===2?"bg-green-500/20 text-green-400":r.act===3?"bg-purple-500/20 text-purple-400":"bg-amber-500/20 text-amber-400"}`,children:r.act===4?"COMPLETE":`ACT ${r.act}`}),e.jsx("span",{className:"text-dark-100 font-semibold",children:r.title})]}),e.jsx("p",{className:"text-dark-400 text-sm",children:r.description})]},s.step)}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4",children:[e.jsxs("div",{className:"text-center mb-3",children:[e.jsx("div",{className:"w-12 h-12 mx-auto bg-blue-500/20 rounded-full flex items-center justify-center text-2xl mb-2",children:"ðŸ‘¤"}),e.jsx("span",{className:"text-blue-400 font-semibold text-sm",children:"Initiator"})]}),e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsxs("div",{className:"bg-dark-700 rounded p-2",children:[e.jsx("span",{className:"text-dark-500",children:"Ephemeral:"}),e.jsx("span",{className:"text-dark-300 ml-1 font-mono",children:s.initiatorEphemeral||"â€”"})]}),e.jsxs("div",{className:"bg-dark-700 rounded p-2",children:[e.jsx("span",{className:"text-dark-500",children:"Static:"}),e.jsx("span",{className:"text-dark-300 ml-1 font-mono",children:"known"})]})]})]}),e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4 flex flex-col",children:[e.jsx("span",{className:"text-dark-500 text-xs text-center mb-3",children:"Messages"}),e.jsxs("div",{className:"flex-1 space-y-2 overflow-y-auto",children:[s.messages.map((t,i)=>e.jsx(c.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},className:`flex items-center text-xs ${t.from==="Initiator"?"justify-start":"justify-end"}`,children:e.jsxs("div",{className:`px-2 py-1 rounded ${t.from==="Initiator"?"bg-blue-500/20 text-blue-400":"bg-green-500/20 text-green-400"}`,children:[t.content," (",t.bytes,"B) â†’"]})},i)),s.messages.length===0&&e.jsx("div",{className:"text-dark-600 text-center text-xs",children:"No messages yet"})]})]}),e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4",children:[e.jsxs("div",{className:"text-center mb-3",children:[e.jsx("div",{className:"w-12 h-12 mx-auto bg-green-500/20 rounded-full flex items-center justify-center text-2xl mb-2",children:"ðŸ–¥ï¸"}),e.jsx("span",{className:"text-green-400 font-semibold text-sm",children:"Responder"})]}),e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsxs("div",{className:"bg-dark-700 rounded p-2",children:[e.jsx("span",{className:"text-dark-500",children:"Ephemeral:"}),e.jsx("span",{className:"text-dark-300 ml-1 font-mono",children:s.responderEphemeral||"â€”"})]}),e.jsxs("div",{className:"bg-dark-700 rounded p-2",children:[e.jsx("span",{className:"text-dark-500",children:"Static:"}),e.jsx("span",{className:"text-dark-300 ml-1 font-mono",children:"known to init"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4",children:[e.jsx("span",{className:"text-dark-500 text-xs",children:"Shared Secrets"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:s.sharedSecrets.length>0?s.sharedSecrets.map((t,i)=>e.jsx(c.span,{initial:{scale:0},animate:{scale:1},className:"px-2 py-1 bg-amber-500/20 text-amber-400 text-xs rounded font-mono",children:t},i)):e.jsx("span",{className:"text-dark-600 text-xs",children:"None yet"})})]}),e.jsx("div",{className:"bg-dark-800 rounded-xl p-4",children:e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-dark-500",children:"Chaining Key:"}),e.jsx("span",{className:"text-dark-300 ml-2 font-mono",children:s.chainingKey})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-dark-500",children:"Hash:"}),e.jsx("span",{className:"text-dark-300 ml-2 font-mono",children:s.handshakeHash})]})]})})]})]})}function I(){return e.jsxs(v,{sectionId:2,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"BOLT #8: Encrypted Transport"}),e.jsx(w,{className:"mb-8"}),e.jsx("p",{className:"mb-4",children:"BOLT #8 specifies the encrypted and authenticated communication protocol between Lightning nodes. It uses the Noise Protocol Framework to establish secure channels with forward secrecy."}),e.jsx(o,{type:"info",title:"Why Start with BOLT #8?",children:"Although numbered 8, this specification is foundational. All Lightning communication happens over an encrypted transport layer, so understanding it first provides context for all other protocol messages."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The Noise_XK Handshake"}),e.jsx("p",{className:"mb-4",children:"Lightning uses the Noise_XK handshake pattern, where:"}),e.jsxs("ul",{className:"list-disc list-inside mb-6 space-y-2 text-dark-200",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"X:"})," The initiator's static key is transmitted (encrypted)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"K:"})," The responder's static key is known ahead of time"]})]}),e.jsx(a,{title:"Noise Protocol Framework",children:"A framework for building cryptographic protocols. It provides patterns for key exchange and message encryption using Diffie-Hellman operations, symmetric encryption, and hashing."}),e.jsx("p",{className:"mb-4",children:'The handshake consists of three "acts," requiring 1.5 round trips to complete:'}),e.jsx(h,{title:"Three-Act Handshake",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Act One (50 bytes):"})," Initiator â†’ Responder",e.jsx("p",{className:"text-sm text-dark-300 mt-1",children:"Initiator sends ephemeral public key + encrypted payload"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Act Two (50 bytes):"})," Responder â†’ Initiator",e.jsx("p",{className:"text-sm text-dark-300 mt-1",children:"Responder sends ephemeral public key + encrypted payload"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Act Three (66 bytes):"})," Initiator â†’ Responder",e.jsx("p",{className:"text-sm text-dark-300 mt-1",children:"Initiator sends encrypted static public key + authentication tag"})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Cryptographic Primitives"}),e.jsx("p",{className:"mb-4",children:"The Lightning transport layer uses three core cryptographic building blocks:"}),e.jsx(a,{title:"Elliptic Curve: secp256k1",children:"The same elliptic curve used by Bitcoin. All key pairs and Diffie-Hellman operations use secp256k1, ensuring compatibility with Bitcoin's cryptographic ecosystem."}),e.jsx(a,{title:"Hash Function: SHA-256",children:"Used for key derivation, chaining, and message authentication. The hash of all exchanged handshake data (h) prevents man-in-the-middle attacks."}),e.jsx(a,{title:"AEAD Cipher: ChaCha20-Poly1305",children:"Authenticated Encryption with Associated Data. Provides both confidentiality (ChaCha20 stream cipher) and integrity (Poly1305 MAC) for all messages."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The Handshake in Detail"}),e.jsx(m,{title:"Act One: Initiator's Opening",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{children:"The initiator (who knows the responder's public key) sends:"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1 mt-2",children:[e.jsx("li",{children:"Generate ephemeral key pair (e, e.pub)"}),e.jsx("li",{children:"Perform ECDH: es = ECDH(e, rs) where rs is responder's static key"}),e.jsx("li",{children:"Derive encryption key from es using HKDF"}),e.jsx("li",{children:"Send: version (1 byte) + e.pub (33 bytes) + encrypted tag (16 bytes)"})]})]})}),e.jsx(m,{title:"Act Two: Responder's Reply",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{children:"The responder receives Act One, validates, and responds:"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1 mt-2",children:[e.jsx("li",{children:"Generate ephemeral key pair (e, e.pub)"}),e.jsx("li",{children:"Perform ECDH: ee = ECDH(e, re) where re is initiator's ephemeral key"}),e.jsx("li",{children:"Perform ECDH: es = ECDH(s, re) using own static key"}),e.jsx("li",{children:"Derive encryption key from combined secrets"}),e.jsx("li",{children:"Send: version (1 byte) + e.pub (33 bytes) + encrypted tag (16 bytes)"})]})]})}),e.jsx(m,{title:"Act Three: Initiator's Authentication",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{children:"The initiator completes authentication:"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1 mt-2",children:[e.jsx("li",{children:"Perform ECDH: ee = ECDH(e, re) with responder's ephemeral key"}),e.jsx("li",{children:"Perform ECDH: se = ECDH(s, re) using own static key"}),e.jsx("li",{children:"Encrypt own static public key"}),e.jsx("li",{children:"Send: version (1 byte) + encrypted static key (49 bytes) + tag (16 bytes)"})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Post-Handshake Encryption"}),e.jsx("p",{className:"mb-4",children:"After the handshake completes, both parties derive symmetric sending and receiving keys. All subsequent messages are encrypted using ChaCha20-Poly1305."}),e.jsxs(a,{title:"Message Encryption Format",children:[e.jsx("p",{className:"mb-2",children:"Each encrypted message contains:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Length (2 bytes):"})," Encrypted message length (big-endian)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Length MAC (16 bytes):"})," Authentication tag for length"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Ciphertext (variable):"})," Encrypted message body"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Body MAC (16 bytes):"})," Authentication tag for body"]})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Key Rotation"}),e.jsx("p",{className:"mb-4",children:"To maintain forward secrecy, encryption keys are rotated every 1000 messages. This limits the damage if a key is compromisedâ€”only messages encrypted with that specific key can be decrypted."}),e.jsx(h,{title:"Key Rotation Process",children:e.jsxs("ol",{className:"list-decimal list-inside space-y-2",children:[e.jsx("li",{children:"After encrypting/decrypting 1000 messages with key k"}),e.jsx("li",{children:"Derive new key: k' = SHA256(k)"}),e.jsx("li",{children:"Reset nonce counter to 0"}),e.jsx("li",{children:"Securely delete old key k"})]})}),e.jsxs(o,{type:"success",title:"Security Properties",children:["The Noise_XK handshake provides:",e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Forward Secrecy:"})," Past sessions remain secure if keys are compromised"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Identity Hiding:"})," Initiator's identity protected from passive observers"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Mutual Authentication:"})," Both parties prove their identity"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Replay Protection:"})," Nonces prevent message replay attacks"]})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Connection Ports"}),e.jsx("p",{className:"mb-4",children:"Lightning nodes use standardized TCP ports for different networks:"}),e.jsx(h,{title:"Standard Lightning Ports",children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"9735:"})," Bitcoin mainnet"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"19735:"})," Bitcoin testnet"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"39735:"})," Bitcoin signet"]})]})}),e.jsx(o,{type:"warning",title:"Connection Handling",children:"Nodes MUST only maintain a single connection to each peer. If a duplicate connection is detected, the newer connection should be dropped. The specification defines rules for determining which connection to keep based on node IDs."})]})}export{I as default};
