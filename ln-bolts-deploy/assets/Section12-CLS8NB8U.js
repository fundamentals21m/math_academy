import{j as e}from"./vendor-animation-0o8UKZ_1.js";import"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-DFrfwBbR.js";import{L as a,D as i,T as s,E as n,C as r}from"./Callout-DlDYJSPr.js";import{M as t}from"./MathBlock-BfkVbDlQ.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";function y(){return e.jsxs(a,{sectionId:12,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"Key Derivation"}),e.jsx("p",{className:"mb-4",children:"Lightning channels use a sophisticated key derivation scheme that enables revocation, watchtowers, and secure state management. This section covers how keys are derived for each commitment transaction."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Basepoints and Per-Commitment Points"}),e.jsx("p",{className:"mb-4",children:'During channel establishment, each party shares several "basepoint" public keys. These are combined with per-commitment points to derive the actual keys used in each commitment transaction.'}),e.jsxs(i,{title:"Basepoints",children:["Each party provides these basepoints during channel opening:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"revocation_basepoint:"})," For constructing revocation keys"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"payment_basepoint:"})," For to_remote outputs"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"delayed_payment_basepoint:"})," For to_local outputs"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"htlc_basepoint:"})," For HTLC scripts"]})]})]}),e.jsxs(i,{title:"Per-Commitment Point",children:["A unique elliptic curve point generated for each commitment transaction. Derived from a per-commitment secret using:",e.jsx(t,{children:"\\text{per\\_commitment\\_point} = \\text{per\\_commitment\\_secret} \\times G"}),"where G is the generator point of secp256k1."]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Key Derivation Functions"}),e.jsxs(s,{title:"Deriving Public Keys",children:["For most keys, the derivation uses elliptic curve point addition:",e.jsx(t,{children:"\\text{pubkey} = \\text{basepoint} + \\text{SHA256}(\\text{per\\_commitment\\_point} \\| \\text{basepoint}) \\times G"}),"This creates a unique key for each commitment while allowing the holder of the basepoint's private key to derive the corresponding private key."]}),e.jsx(n,{title:"Deriving local_delayedpubkey",children:e.jsxs("ol",{className:"list-decimal list-inside space-y-2 text-sm",children:[e.jsx("li",{children:"Take delayed_payment_basepoint and per_commitment_point"}),e.jsx("li",{children:"Compute: hash = SHA256(per_commitment_point || delayed_payment_basepoint)"}),e.jsx("li",{children:"Multiply hash by G (generator point)"}),e.jsx("li",{children:"Add result to delayed_payment_basepoint"}),e.jsx("li",{children:"Result is the local_delayedpubkey for this commitment"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Revocation Keys"}),e.jsxs("p",{className:"mb-4",children:["Revocation keys are special—they require information from ",e.jsx("em",{children:"both"})," parties to construct the private key. This enables the penalty mechanism."]}),e.jsxs(s,{title:"Revocation Public Key",children:[e.jsx(t,{children:"\\text{revocationpubkey} = \\text{revocation\\_basepoint} \\times \\text{SHA256}(R \\| P) + P \\times \\text{SHA256}(P \\| R)"}),"where R is revocation_basepoint and P is per_commitment_point."]}),e.jsxs(s,{title:"Revocation Private Key",children:["The private key can only be computed when both secrets are known:",e.jsx(t,{children:"\\text{revocationsecretkey} = r \\times \\text{SHA256}(R \\| P) + p \\times \\text{SHA256}(P \\| R)"}),"where r is the revocation_basepoint private key and p is the per_commitment_secret."]}),e.jsx(r,{type:"info",title:"Why This Matters",children:"When a commitment is revoked, the per_commitment_secret (p) is revealed. Combined with the counterparty's revocation_basepoint private key (r), they can compute the revocationsecretkey and claim all funds from a revoked commitment."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Per-Commitment Secret Generation"}),e.jsx("p",{className:"mb-4",children:"Per-commitment secrets are generated using a compact tree structure that allows efficient storage and verification:"}),e.jsxs(i,{title:"Shachain",children:["A hash chain structure where each secret can be derived from the next. Given secret N, all previous secrets (0 to N-1) can be computed, but secret N+1 cannot be derived.",e.jsx(t,{children:"\\text{secret}_n = \\text{derive}(\\text{seed}, n)"}),"This allows storing just log(N) secrets to verify any of the first N secrets."]}),e.jsx(n,{title:"Secret Derivation Tree",children:e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsx("p",{children:"For a 48-bit commitment number, the tree has 48 levels:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 mt-2",children:[e.jsx("li",{children:"Root seed → can derive all 2^48 secrets"}),e.jsx("li",{children:"Each level halves by applying SHA256"}),e.jsx("li",{children:"Storage: max 48 secrets needed to verify any prior"})]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Static vs Derived Keys"}),e.jsxs("p",{className:"mb-4",children:["With ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"option_static_remotekey"}),", the remote party's payment key doesn't vary with commitment number:"]}),e.jsx(n,{title:"Static Remote Key",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-dark-700",children:[e.jsx("th",{className:"text-left py-2",children:"Key Type"}),e.jsx("th",{className:"text-left py-2",children:"Without Static"}),e.jsx("th",{className:"text-left py-2",children:"With Static"})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2",children:"to_remote"}),e.jsx("td",{className:"py-2",children:"Derived per-commitment"}),e.jsx("td",{className:"py-2",children:"Fixed payment_basepoint"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2",children:"Recovery"}),e.jsx("td",{className:"py-2",children:"Needs per-commitment data"}),e.jsx("td",{className:"py-2",children:"Simple—just the key"})]})]})]})}),e.jsx(r,{type:"success",title:"Benefits of Static Remote Key",children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Simplified backup: only need the base key"}),e.jsx("li",{children:"Any commitment version can be recovered"}),e.jsx("li",{children:"Enabled by default in modern implementations"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Watchtower Compatibility"}),e.jsx("p",{className:"mb-4",children:"The key derivation scheme supports watchtowers—third parties that monitor for revoked commitments and can submit penalty transactions:"}),e.jsxs(s,{title:"Watchtower Requirements",children:["A watchtower needs:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsx("li",{children:"The commitment transaction to watch for"}),e.jsx("li",{children:"The pre-signed penalty transaction (or info to construct it)"}),e.jsx("li",{children:"It does NOT need the per_commitment_secret until breach occurs"})]}),"The watchtower can submit the penalty transaction if it sees a revoked commitment, claiming a fee while returning the rest to the channel owner."]})]})}export{y as default};
