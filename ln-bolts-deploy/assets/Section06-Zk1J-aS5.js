import{j as e}from"./vendor-animation-0o8UKZ_1.js";import"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-DFrfwBbR.js";import{L as a,C as s,D as t,T as n,E as i}from"./Callout-DlDYJSPr.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";function p(){return e.jsxs(a,{sectionId:6,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"Interactive Transaction Construction"}),e.jsx("p",{className:"mb-4",children:'The v2 channel protocol introduces interactive transaction construction, enabling both parties to contribute inputs and outputs to the funding transaction. This enables "dual-funded" channels where both peers provide initial capital.'}),e.jsxs(s,{type:"info",title:"V2 Channel Protocol",children:["Interactive transaction construction was introduced with",e.jsx("code",{className:"bg-dark-800 px-1 rounded mx-1",children:"option_dual_fund"}),". It replaces the v1 funding_created/funding_signed flow with a more flexible negotiation."]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Opening a V2 Channel"}),e.jsx("p",{className:"mb-4",children:"V2 channels use open_channel2 and accept_channel2 messages:"}),e.jsxs(t,{title:"open_channel2 (type 64)",children:["Similar to open_channel but with key differences:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"funding_feerate_perkw:"})," Fee rate for the funding transaction"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"locktime:"})," nLockTime for the funding transaction"]}),e.jsx("li",{children:"No funding_satoshisâ€”determined during interactive construction"})]})]}),e.jsxs(t,{title:"accept_channel2 (type 65)",children:["Accepts the v2 channel proposal. The fundee can indicate willingness to contribute:",e.jsx("ul",{className:"mt-2 list-disc list-inside space-y-1",children:e.jsxs("li",{children:[e.jsx("strong",{children:"funding_satoshis:"})," Amount the acceptor will contribute (can be 0)"]})})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The Construction Protocol"}),e.jsx("p",{className:"mb-4",children:"After open_channel2/accept_channel2, peers enter interactive construction. They take turns adding inputs and outputs until both signal completion."}),e.jsxs(n,{title:"Serial ID Assignment",children:["Each input and output gets a unique 64-bit serial ID:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Initiator:"})," Uses even serial IDs (0, 2, 4, ...)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Non-initiator:"})," Uses odd serial IDs (1, 3, 5, ...)"]})]}),"Inputs and outputs are ordered by serial ID in the final transaction."]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Construction Messages"}),e.jsxs(t,{title:"tx_add_input (type 66)",children:["Adds an input to the transaction:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"serial_id: 8 bytes (unique identifier)"}),e.jsx("p",{children:"prevtx: complete serialized previous tx"}),e.jsx("p",{children:"prevtx_vout: 4 bytes (output index)"}),e.jsx("p",{children:"sequence: 4 bytes"})]})]}),e.jsxs(t,{title:"tx_add_output (type 67)",children:["Adds an output to the transaction:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"serial_id: 8 bytes"}),e.jsx("p",{children:"sats: 8 bytes (output amount)"}),e.jsx("p",{children:"script: variable (output script)"})]})]}),e.jsxs(t,{title:"tx_remove_input (type 68)",children:["Removes a previously added input:",e.jsx("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2",children:e.jsx("p",{children:"channel_id: 32 bytes, serial_id: 8 bytes"})})]}),e.jsxs(t,{title:"tx_remove_output (type 69)",children:["Removes a previously added output:",e.jsx("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2",children:e.jsx("p",{children:"channel_id: 32 bytes, serial_id: 8 bytes"})})]}),e.jsxs(t,{title:"tx_complete (type 70)",children:["Signals that a peer has no more changes to make:",e.jsx("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2",children:e.jsx("p",{children:"channel_id: 32 bytes"})})]}),e.jsx(i,{title:"Interactive Construction Flow",children:e.jsxs("div",{className:"font-mono text-sm space-y-2",children:[e.jsx("p",{className:"text-blue-400",children:"Initiator: tx_add_input (serial_id=0, their UTXO)"}),e.jsx("p",{className:"text-green-400",children:"Acceptor: tx_add_input (serial_id=1, their UTXO)"}),e.jsx("p",{className:"text-blue-400",children:"Initiator: tx_add_output (serial_id=2, funding output)"}),e.jsx("p",{className:"text-green-400",children:"Acceptor: tx_add_output (serial_id=3, their change)"}),e.jsx("p",{className:"text-blue-400",children:"Initiator: tx_add_output (serial_id=4, their change)"}),e.jsx("p",{className:"text-blue-400",children:"Initiator: tx_complete"}),e.jsx("p",{className:"text-green-400",children:"Acceptor: tx_complete"}),e.jsx("p",{className:"text-gray-400",children:"--- Construction complete ---"})]})}),e.jsxs(s,{type:"warning",title:"Completion Requirement",children:["Construction is only complete when ",e.jsx("strong",{children:"both"})," peers send consecutive tx_complete messages. If either peer sends another modification after tx_complete, both must send tx_complete again."]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Signature Exchange"}),e.jsx("p",{className:"mb-4",children:"Once construction is complete, peers exchange signatures for the funding transaction:"}),e.jsxs(t,{title:"tx_signatures (type 71)",children:["Contains witness data for all inputs a peer contributed:",e.jsxs("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"channel_id: 32 bytes"}),e.jsx("p",{children:"txid: 32 bytes (the funding txid)"}),e.jsx("p",{children:"num_witnesses: 2 bytes"}),e.jsx("p",{children:"witnesses: array of witness stacks"})]})]}),e.jsxs(n,{title:"Signature Ordering",children:["The ",e.jsx("strong",{children:"non-initiator"})," sends tx_signatures first. This protects the initiator from creating a valid transaction that the non-initiator refuses to sign."]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Fee Responsibility"}),e.jsx("p",{className:"mb-4",children:"In dual-funded channels, fees are split based on contribution:"}),e.jsxs(i,{title:"Fee Calculation",children:[e.jsx("p",{className:"mb-2",children:"For a dual-funded channel:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Common fields (version, locktime, funding output) split 50/50"}),e.jsx("li",{children:"Each peer pays for their own inputs and change outputs"}),e.jsx("li",{children:"Fees are based on the negotiated funding_feerate_perkw"})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Replace-By-Fee (RBF)"}),e.jsx("p",{className:"mb-4",children:"V2 channels support fee bumping via RBF if the funding transaction hasn't confirmed:"}),e.jsxs(t,{title:"tx_init_rbf (type 72)",children:["Proposes an RBF of the funding transaction:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"channel_id:"})," The channel being modified"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"locktime:"})," New transaction locktime"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"feerate:"})," New (higher) fee rate"]})]})]}),e.jsx(t,{title:"tx_ack_rbf (type 73)",children:"Accepts the RBF proposal, then peers re-enter interactive construction with the new fee rate."}),e.jsx(s,{type:"info",title:"RBF Constraints",children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"New feerate must be higher than the original"}),e.jsx("li",{children:"The funding output must remain the same"}),e.jsx("li",{children:"Peers can add/remove other inputs/outputs as needed"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Transaction Abort"}),e.jsx(t,{title:"tx_abort (type 74)",children:"Either peer can abort the construction at any time. No channel is created, and any broadcast transactions should not be spent (though there's no enforcement)."})]})}export{p as default};
