import{j as e,A as w,m as y}from"./vendor-animation-0o8UKZ_1.js";import{r as c}from"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-BbBpzejs.js";import{L as A}from"./LessonLayout-Bq4tucEw.js";import{M as E}from"./MathBlock-BfkVbDlQ.js";import{T as N,D as l,E as k,C as v}from"./Callout-BvJhqaqq.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";const C={fundingAmount:1e6,aliceBalance:6e5,bobBalance:4e5,htlcs:[],feeRate:5,dustLimit:546,toSelfDelay:144};function L({className:_=""}){const[s,m]=c.useState(C),[r,x]=c.useState("alice"),[h,O]=c.useState(!1),[u,p]=c.useState(1),b=724+s.htlcs.length*172,o=Math.floor(s.feeRate*b/1e3),f=c.useMemo(()=>{const t=[],i=r==="alice",n=i?s.aliceBalance-o:s.bobBalance-o;n>s.dustLimit&&t.push({name:"to_local",amount:n,script:`OP_IF <revocation_key> OP_ELSE ${s.toSelfDelay} OP_CSV <local_delayed_key> OP_ENDIF OP_CHECKSIG`,color:i?"bg-blue-500/20 text-blue-400":"bg-green-500/20 text-green-400",delayed:!0});const g=i?s.bobBalance:s.aliceBalance;return g>s.dustLimit&&t.push({name:"to_remote",amount:g,script:"OP_0 <remote_pubkey_hash> (P2WPKH)",color:i?"bg-green-500/20 text-green-400":"bg-blue-500/20 text-blue-400",delayed:!1}),s.htlcs.forEach(a=>{if(a.amount>s.dustLimit){const d=i&&a.direction==="offered"||!i&&a.direction==="received";t.push({name:d?`HTLC Offered #${a.id}`:`HTLC Received #${a.id}`,amount:a.amount,script:d?`<revocation> OR (<remote_htlc> AND <preimage>) OR (<local_htlc> AND CLTV ${a.expiry})`:`<revocation> OR (<remote_htlc> AND CLTV ${a.expiry}) OR (<local_htlc> AND <preimage>)`,color:"bg-amber-500/20 text-amber-400",delayed:!1})}}),t.sort((a,d)=>a.amount-d.amount)},[s,r,o]),j=t=>{m(n=>({...n,htlcs:[...n.htlcs,{id:u,amount:5e4,direction:t,expiry:7e5+u*100}]})),p(n=>n+1)},T=t=>{m(i=>({...i,htlcs:i.htlcs.filter(n=>n.id!==t)}))},P=()=>{m(C),p(1)};return e.jsxs("div",{className:`bg-dark-900 rounded-2xl p-6 ${_}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-dark-100",children:"Commitment Transaction Builder"}),e.jsx("button",{onClick:P,className:"px-3 py-1 text-sm bg-dark-700 hover:bg-dark-600 text-dark-300 rounded-lg transition-colors",children:"Reset"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-6",children:[e.jsx("span",{className:"text-dark-400 text-sm",children:"Viewing:"}),e.jsxs("div",{className:"flex bg-dark-800 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>x("alice"),className:`px-4 py-1 text-sm rounded-md transition-colors ${r==="alice"?"bg-blue-500/20 text-blue-400":"text-dark-400 hover:text-dark-200"}`,children:"Alice's Commitment"}),e.jsx("button",{onClick:()=>x("bob"),className:`px-4 py-1 text-sm rounded-md transition-colors ${r==="bob"?"bg-green-500/20 text-green-400":"text-dark-400 hover:text-dark-200"}`,children:"Bob's Commitment"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4",children:[e.jsx("h4",{className:"text-dark-300 font-semibold mb-3",children:"Input"}),e.jsxs("div",{className:"bg-dark-700 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-purple-400 font-mono text-sm",children:"Funding Output"}),e.jsxs("span",{className:"text-dark-200 font-mono",children:[(s.fundingAmount/1e8).toFixed(8)," BTC"]})]}),e.jsx("div",{className:"text-xs text-dark-500 mt-1",children:"2-of-2 multisig (Alice + Bob)"})]})]}),e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4",children:[e.jsxs("h4",{className:"text-dark-300 font-semibold mb-3",children:["Outputs (",f.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:e.jsx(w,{children:f.map((t,i)=>e.jsxs(y.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},transition:{delay:i*.1},className:`rounded-lg p-3 ${t.color}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-mono text-sm",children:t.name}),t.delayed&&e.jsxs("span",{className:"px-1.5 py-0.5 bg-dark-800 text-xs rounded",children:["â³ ",s.toSelfDelay," blocks"]})]}),e.jsx("span",{className:"font-mono text-sm",children:(t.amount/1e8).toFixed(8)})]}),h&&e.jsx("div",{className:"mt-2 text-xs opacity-70 font-mono break-all",children:t.script})]},t.name))})})]})]}),e.jsxs("div",{className:"bg-dark-800 rounded-xl p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-dark-300 font-semibold",children:"Active HTLCs"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>j("offered"),className:"px-3 py-1 text-xs bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 rounded-lg transition-colors",children:"+ Offered"}),e.jsx("button",{onClick:()=>j("received"),className:"px-3 py-1 text-xs bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg transition-colors",children:"+ Received"})]})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.htlcs.length===0?e.jsx("span",{className:"text-dark-500 text-sm",children:"No HTLCs - channel in simple state"}):s.htlcs.map(t=>e.jsxs(y.div,{initial:{scale:0},animate:{scale:1},className:`flex items-center gap-2 px-3 py-1 rounded-lg ${t.direction==="offered"?"bg-blue-500/20":"bg-green-500/20"}`,children:[e.jsxs("span",{className:`text-sm ${t.direction==="offered"?"text-blue-400":"text-green-400"}`,children:["#",t.id,": ",(t.amount/1e3).toFixed(0),"k sats"]}),e.jsx("button",{onClick:()=>T(t.id),className:"text-dark-500 hover:text-red-400 transition-colors",children:"Ã—"})]},t.id))})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-dark-800 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-dark-500 text-xs",children:"Weight"}),e.jsxs("div",{className:"text-dark-200 font-mono",children:[b," WU"]})]}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-dark-500 text-xs",children:"Fee Rate"}),e.jsxs("div",{className:"text-dark-200 font-mono",children:[s.feeRate," sat/vB"]})]}),e.jsxs("div",{className:"bg-dark-800 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-dark-500 text-xs",children:"Total Fee"}),e.jsxs("div",{className:"text-amber-400 font-mono",children:[o," sats"]})]})]}),e.jsx("button",{onClick:()=>O(!h),className:"w-full py-2 text-sm text-dark-400 hover:text-dark-200 transition-colors",children:h?"â–² Hide Scripts":"â–¼ Show Scripts"}),e.jsxs("div",{className:"mt-4 p-4 bg-amber-500/10 border border-amber-500/20 rounded-xl",children:[e.jsx("div",{className:"text-amber-400 text-sm font-semibold mb-1",children:"ðŸ’¡ Asymmetry"}),e.jsx("p",{className:"text-dark-300 text-sm",children:r==="alice"?"In Alice's commitment, her output is delayed (to_local). If she broadcasts this, Bob gets his funds immediately while Alice waits.":"In Bob's commitment, his output is delayed (to_local). If he broadcasts this, Alice gets her funds immediately while Bob waits."})]})]})}function U(){return e.jsxs(A,{sectionId:10,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"Commitment Transactions"}),e.jsx(L,{className:"mb-8"}),e.jsx("p",{className:"mb-4",children:"Commitment transactions represent the current state of a Lightning channel. Each party holds their own version, and either can broadcast to close the channel. This section details their structure and the asymmetric design that enables revocation."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Asymmetric Commitments"}),e.jsxs("p",{className:"mb-4",children:["A crucial insight: Alice and Bob hold ",e.jsx("em",{children:"different"})," commitment transactions for the same channel state. This asymmetry enables the penalty mechanism."]}),e.jsxs(N,{title:"Commitment Transaction Asymmetry",children:["For the same channel state:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Alice's commitment: her output has a CSV delay; Bob's is immediately spendable"}),e.jsx("li",{children:"Bob's commitment: his output has a CSV delay; Alice's is immediately spendable"})]}),"This ensures the broadcaster must wait, giving the counterparty time to penalize a revoked state."]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Commitment Transaction Structure"}),e.jsx(l,{title:"Commitment Transaction Format",children:e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Version:"})," 2"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Input:"})," The funding output (sequence: 0x80000000)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Outputs:"})," to_local, to_remote, HTLCs (in specific order)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Locktime:"})," Encodes the obscured commitment number"]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Output Types"}),e.jsxs(l,{title:"to_local Output",children:["The broadcaster's balance, delayed by to_self_delay blocks. Can also be claimed immediately using the revocation key (if the commitment is revoked).",e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded mt-2 space-y-1",children:[e.jsx("p",{children:"OP_IF"}),e.jsx("p",{className:"pl-4",children:"<revocationpubkey>"}),e.jsx("p",{children:"OP_ELSE"}),e.jsx("p",{className:"pl-4",children:"<to_self_delay> OP_CHECKSEQUENCEVERIFY OP_DROP"}),e.jsx("p",{className:"pl-4",children:"<local_delayedpubkey>"}),e.jsx("p",{children:"OP_ENDIF"}),e.jsx("p",{children:"OP_CHECKSIG"})]})]}),e.jsxs(l,{title:"to_remote Output",children:["The non-broadcaster's balance. With static_remotekey, this is a simple P2WPKH:",e.jsx("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded mt-2",children:"OP_0 <20-byte-hash of remote_pubkey>"}),e.jsx("p",{className:"mt-2",children:"This is immediately spendable by the remote party with their payment key."})]}),e.jsxs(k,{title:"Understanding the Delay",children:[e.jsx("p",{className:"mb-2",children:"If Alice broadcasts her commitment transaction:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Alice's funds (to_local): locked for to_self_delay blocks"}),e.jsx("li",{children:"Bob's funds (to_remote): immediately available to Bob"}),e.jsx("li",{children:"If revoked: Bob can claim everything using revocation key"})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Obscured Commitment Number"}),e.jsx("p",{className:"mb-4",children:"The commitment number is hidden in the locktime and sequence fields to prevent observers from determining how many updates the channel has had."}),e.jsxs(l,{title:"Obscuring the Commitment Number",children:[e.jsx(E,{children:"\\text{obscured} = \\text{commitment\\_number} \\oplus (\\text{SHA256}(\\text{basepoints})[:6])"}),e.jsx("p",{className:"mt-2",children:"The lower 24 bits go in the locktime, upper 24 bits in the input sequence. Only the two channel parties can decode the actual commitment number."})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Output Ordering"}),e.jsx("p",{className:"mb-4",children:"Commitment transaction outputs follow a specific ordering to ensure both parties construct identical transactions:"}),e.jsxs(N,{title:"Output Ordering Rules (BIP-69 variant)",children:["Outputs are sorted by:",e.jsxs("ol",{className:"list-decimal list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Value (ascending)"}),e.jsx("li",{children:"scriptPubKey length (ascending)"}),e.jsx("li",{children:"scriptPubKey bytes (lexicographic)"})]}),"For HTLC outputs with equal values and scripts, sort by CLTV expiry (ascending)."]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Fees and Dust"}),e.jsx("p",{className:"mb-4",children:"The funder pays all commitment transaction fees, deducted from their output:"}),e.jsxs(k,{title:"Fee Calculation",children:[e.jsx("p",{className:"mb-2",children:"Fee components:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-sm",children:[e.jsx("li",{children:"Base weight: ~724 weight units (1 input, 2 outputs)"}),e.jsx("li",{children:"Per HTLC: +172 weight units"}),e.jsx("li",{children:"Fee = feerate_per_kw Ã— total_weight / 1000"})]})]}),e.jsx(l,{title:"Dust Limit",children:"Outputs below the dust_limit_satoshis are not created on-chain. Their value is added to the fee. The standard dust limit for P2WSH outputs is 330 satoshis."}),e.jsx(v,{type:"warning",title:"Trimmed HTLCs",children:`If an HTLC's value minus its transaction cost falls below the dust limit, the HTLC is "trimmed" from the commitment transaction. The value goes to fees, but the HTLC is still tracked for off-chain resolution.`}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Anchor Outputs"}),e.jsx("p",{className:"mb-4",children:"With anchor outputs, commitment transactions include small (330 sat) outputs for each party to enable CPFP fee bumping:"}),e.jsxs(l,{title:"Anchor Output Script",children:[e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded space-y-1",children:[e.jsx("p",{children:"<local/remote_funding_pubkey> OP_CHECKSIG"}),e.jsx("p",{children:"OP_IFDUP OP_NOTIF"}),e.jsx("p",{className:"pl-4",children:"16 OP_CHECKSEQUENCEVERIFY"}),e.jsx("p",{children:"OP_ENDIF"})]}),e.jsx("p",{className:"mt-2",children:"The owner can spend immediately; anyone can spend after 16 blocks (cleanup)."})]}),e.jsx(v,{type:"info",title:"Why Anchors?",children:"Anchors allow commitment transactions to be broadcast with minimal fees, then fee-bumped using Child-Pays-For-Parent (CPFP). This is crucial when on-chain fees spike unexpectedly."})]})}export{U as default};
