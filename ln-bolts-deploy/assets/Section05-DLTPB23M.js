import{j as e,m as b}from"./vendor-animation-0o8UKZ_1.js";import{r as x}from"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-BbBpzejs.js";import{L as F}from"./LessonLayout-Bq4tucEw.js";import{E as p,D as r,C as u,T}from"./Callout-BvJhqaqq.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";const j={initial:{name:"Initial",description:"No channel exists. Either party can initiate opening.",color:"text-dark-400",bgColor:"bg-dark-700"},open_sent:{name:"Open Sent",description:"Funder has sent open_channel message.",color:"text-blue-400",bgColor:"bg-blue-500/20",messages:["open_channel (type 32)"]},accept_received:{name:"Accept Received",description:"Fundee has accepted with accept_channel.",color:"text-blue-400",bgColor:"bg-blue-500/20",messages:["accept_channel (type 33)"]},funding_created:{name:"Funding Created",description:"Funder has created funding tx and sent signature.",color:"text-purple-400",bgColor:"bg-purple-500/20",messages:["funding_created (type 34)"]},funding_signed:{name:"Funding Signed",description:"Fundee has returned their signature.",color:"text-purple-400",bgColor:"bg-purple-500/20",messages:["funding_signed (type 35)"]},funding_broadcast:{name:"Funding Broadcast",description:"Funding transaction broadcast to Bitcoin network.",color:"text-amber-400",bgColor:"bg-amber-500/20",messages:["Bitcoin TX"]},awaiting_confirmations:{name:"Awaiting Confirmations",description:"Waiting for minimum_depth confirmations.",color:"text-amber-400",bgColor:"bg-amber-500/20"},channel_ready:{name:"Channel Ready",description:"Both parties have sent channel_ready.",color:"text-green-400",bgColor:"bg-green-500/20",messages:["channel_ready (type 36)"]},operational:{name:"Operational",description:"Channel is active and can route payments.",color:"text-green-400",bgColor:"bg-green-500/20",messages:["update_add_htlc","commitment_signed","revoke_and_ack"]},shutdown_sent:{name:"Shutdown Initiated",description:"One party has sent shutdown message.",color:"text-orange-400",bgColor:"bg-orange-500/20",messages:["shutdown (type 38)"]},closing:{name:"Closing",description:"Negotiating closing transaction.",color:"text-red-400",bgColor:"bg-red-500/20",messages:["closing_signed (type 39)"]},closed:{name:"Closed",description:"Channel is closed. Funds returned on-chain.",color:"text-dark-400",bgColor:"bg-dark-700"}},_=[{from:"initial",to:"open_sent",label:"open_channel"},{from:"open_sent",to:"accept_received",label:"accept_channel"},{from:"accept_received",to:"funding_created",label:"funding_created"},{from:"funding_created",to:"funding_signed",label:"funding_signed"},{from:"funding_signed",to:"funding_broadcast",label:"broadcast"},{from:"funding_broadcast",to:"awaiting_confirmations",label:"wait"},{from:"awaiting_confirmations",to:"channel_ready",label:"channel_ready"},{from:"channel_ready",to:"operational",label:"both ready"},{from:"operational",to:"shutdown_sent",label:"shutdown"},{from:"shutdown_sent",to:"closing",label:"mutual close"},{from:"closing",to:"closed",label:"closing_signed"}],g=["initial","open_sent","accept_received","funding_created","funding_signed","funding_broadcast","awaiting_confirmations","channel_ready","operational","shutdown_sent","closing","closed"];function S({className:N=""}){const[s,o]=x.useState("initial"),[l,i]=x.useState(0),[m]=x.useState(3),a=j[s],f=g.indexOf(s),y=()=>{if(s==="awaiting_confirmations"&&l<m-1){i(n=>n+1);return}const t=_.find(n=>n.from===s);t&&(o(t.to),t.to!=="awaiting_confirmations"&&i(0))},k=()=>{if(s==="awaiting_confirmations"&&l>0){i(n=>n-1);return}const t=_.find(n=>n.to===s);t&&(o(t.from),i(0))},v=()=>{o("initial"),i(0)},w=s!=="closed",C=s!=="initial";return e.jsxs("div",{className:`bg-dark-900 rounded-2xl p-6 ${N}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-dark-100",children:"Channel State Machine"}),e.jsx("button",{onClick:v,className:"px-3 py-1 text-sm bg-dark-700 hover:bg-dark-600 text-dark-300 rounded-lg transition-colors",children:"Reset"})]}),e.jsx("div",{className:"relative mb-8 overflow-x-auto pb-4",children:e.jsx("div",{className:"flex items-center min-w-max",children:g.map((t,n)=>{const c=j[t],d=t===s,h=n<f;return e.jsxs("div",{className:"flex items-center",children:[e.jsxs(b.div,{className:`relative flex flex-col items-center ${d?"scale-110":""}`,animate:{scale:d?1.1:1},children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-all ${d?`${c.bgColor} ${c.color} ring-2 ring-offset-2 ring-offset-dark-900 ring-current`:h?"bg-green-500/30 text-green-400":"bg-dark-700 text-dark-500"}`,children:h?"✓":n+1}),e.jsx("span",{className:`mt-2 text-xs whitespace-nowrap ${d?c.color:h?"text-dark-400":"text-dark-600"}`,children:c.name})]}),n<g.length-1&&e.jsx("div",{className:`w-8 h-0.5 mx-1 ${n<f?"bg-green-500/50":"bg-dark-700"}`})]},t)})})}),e.jsxs(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:`rounded-xl p-6 mb-6 ${a.bgColor}`,children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:`text-2xl font-bold ${a.color}`,children:a.name}),e.jsx("p",{className:"text-dark-300 mt-2",children:a.description})]}),s==="awaiting_confirmations"&&e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-3xl font-bold text-amber-400",children:[l,"/",m]}),e.jsx("div",{className:"text-xs text-dark-400",children:"confirmations"})]})]}),a.messages&&e.jsx("div",{className:"mt-4 flex flex-wrap gap-2",children:a.messages.map((t,n)=>e.jsx("span",{className:"px-2 py-1 bg-dark-800/50 text-dark-300 text-xs rounded font-mono",children:t},n))})]},s),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:k,disabled:!C,className:"px-4 py-2 bg-dark-700 hover:bg-dark-600 disabled:opacity-50 disabled:cursor-not-allowed text-dark-300 rounded-lg transition-colors flex items-center gap-2",children:"← Previous"}),e.jsx("div",{className:"text-center",children:s==="operational"&&e.jsx("div",{className:"text-xs text-green-400 animate-pulse",children:"⚡ Channel Active - Routing Payments"})}),e.jsx("button",{onClick:y,disabled:!w,className:"px-4 py-2 bg-amber-500 hover:bg-amber-400 disabled:opacity-50 disabled:cursor-not-allowed text-dark-900 font-medium rounded-lg transition-colors flex items-center gap-2",children:s==="awaiting_confirmations"?`Add Block (${l+1}/${m})`:"Next State →"})]}),e.jsx("div",{className:"mt-6 pt-4 border-t border-dark-800",children:e.jsxs("div",{className:"grid grid-cols-4 gap-2 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded-full bg-blue-500/30"}),e.jsx("span",{className:"text-dark-400",children:"Negotiation"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded-full bg-purple-500/30"}),e.jsx("span",{className:"text-dark-400",children:"Funding"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded-full bg-green-500/30"}),e.jsx("span",{className:"text-dark-400",children:"Active"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded-full bg-red-500/30"}),e.jsx("span",{className:"text-dark-400",children:"Closing"})]})]})})]})}function B(){return e.jsxs(F,{sectionId:5,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"BOLT #2: Channel Establishment"}),e.jsx(S,{className:"mb-8"}),e.jsx("p",{className:"mb-4",children:"BOLT #2 defines the peer protocol for managing payment channels. This section covers channel establishment—the process of opening a new Lightning channel between two nodes."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Channel Opening Flow"}),e.jsx("p",{className:"mb-4",children:'The v1 (single-funder) channel opening follows a specific message sequence. The "funder" initiates and provides all initial capital; the "fundee" accepts and contributes none.'}),e.jsx(p,{title:"V1 Channel Opening Sequence",children:e.jsxs("div",{className:"font-mono text-sm space-y-2",children:[e.jsx("p",{className:"text-blue-400",children:"Funder → Fundee: open_channel"}),e.jsx("p",{className:"text-green-400",children:"Fundee → Funder: accept_channel"}),e.jsx("p",{className:"text-blue-400",children:"Funder → Fundee: funding_created"}),e.jsx("p",{className:"text-green-400",children:"Fundee → Funder: funding_signed"}),e.jsx("p",{className:"text-gray-400",children:"--- Funder broadcasts funding tx ---"}),e.jsx("p",{className:"text-gray-400",children:"--- Wait for confirmations ---"}),e.jsx("p",{className:"text-blue-400",children:"Funder → Fundee: channel_ready"}),e.jsx("p",{className:"text-green-400",children:"Fundee → Funder: channel_ready"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The open_channel Message"}),e.jsx(r,{title:"open_channel (type 32)",children:"Sent by the funder to propose a new channel. Contains all parameters for the channel."}),e.jsx(p,{title:"Key open_channel Fields",children:e.jsx("table",{className:"w-full text-sm",children:e.jsxs("tbody",{className:"space-y-1",children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"chain_hash"}),e.jsx("td",{className:"py-2",children:"Identifies the blockchain (mainnet, testnet, etc.)"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"temporary_channel_id"}),e.jsx("td",{className:"py-2",children:"32-byte random ID until funding tx is known"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"funding_satoshis"}),e.jsx("td",{className:"py-2",children:"Amount to lock in the funding output"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"push_msat"}),e.jsx("td",{className:"py-2",children:"Initial balance to give the fundee (gift)"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"dust_limit_satoshis"}),e.jsx("td",{className:"py-2",children:'Minimum output value (below = "dust")'})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"max_htlc_value_in_flight_msat"}),e.jsx("td",{className:"py-2",children:"Max value of outstanding HTLCs"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"channel_reserve_satoshis"}),e.jsx("td",{className:"py-2",children:"Minimum balance the peer must maintain"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"htlc_minimum_msat"}),e.jsx("td",{className:"py-2",children:"Smallest HTLC this node will accept"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"feerate_per_kw"}),e.jsx("td",{className:"py-2",children:"Initial fee rate for commitment transactions"})]}),e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2 font-mono",children:"to_self_delay"}),e.jsx("td",{className:"py-2",children:"Timelock for the peer's outputs (in blocks)"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 font-mono",children:"max_accepted_htlcs"}),e.jsx("td",{className:"py-2",children:"Maximum concurrent HTLCs allowed"})]})]})})}),e.jsx("p",{className:"mt-4 mb-4",children:"The message also includes several public keys needed for the channel's operation:"}),e.jsx(p,{title:"Channel Keys in open_channel",children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"funding_pubkey:"})," Used in the 2-of-2 multisig funding output"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"revocation_basepoint:"})," For generating revocation keys"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"payment_basepoint:"})," For the to_remote output"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"delayed_payment_basepoint:"})," For the to_local output"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"htlc_basepoint:"})," For HTLC outputs"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"first_per_commitment_point:"})," For the first commitment transaction"]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"The accept_channel Message"}),e.jsx(r,{title:"accept_channel (type 33)",children:"Sent by the fundee to accept the channel proposal. Contains the fundee's parameters and keys."}),e.jsx("p",{className:"mb-4",children:"The fundee can adjust certain parameters within acceptable ranges but cannot change the funding amount. Key differences from open_channel:"}),e.jsxs("ul",{className:"list-disc list-inside mb-6 space-y-2 text-dark-200",children:[e.jsx("li",{children:"No funding_satoshis or push_msat (funder controls these)"}),e.jsx("li",{children:"No feerate (funder proposes, but fundee can reject)"}),e.jsx("li",{children:"Includes minimum_depth: confirmations required before channel_ready"})]}),e.jsx(u,{type:"warning",title:"Rejecting Channel Requests",children:"The fundee can reject a channel by sending an error message instead of accept_channel. Common reasons include: unacceptable funding amount, incompatible parameters, or capacity limits."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Creating the Funding Transaction"}),e.jsx("p",{className:"mb-4",children:"After accept_channel, the funder constructs the funding transaction. This is a standard Bitcoin transaction with a special output:"}),e.jsxs(T,{title:"Funding Output Structure",children:["The funding output is a P2WSH (Pay-to-Witness-Script-Hash) with a 2-of-2 multisig:",e.jsx("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2",children:e.jsx("p",{children:"OP_2 <funder_pubkey> <fundee_pubkey> OP_2 OP_CHECKMULTISIG"})}),e.jsx("p",{className:"mt-2",children:"Keys are ordered lexicographically to ensure both parties derive the same script."})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Funding Messages"}),e.jsxs(r,{title:"funding_created (type 34)",children:["Funder sends this after constructing the funding transaction:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"funding_txid:"})," Transaction ID of the funding tx"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"funding_output_index:"})," Which output is the funding output"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"signature:"})," Funder's signature for fundee's commitment tx"]})]})]}),e.jsxs(r,{title:"funding_signed (type 35)",children:["Fundee responds with their signature, completing the exchange:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"channel_id:"})," Derived from funding txid and output index"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"signature:"})," Fundee's signature for funder's commitment tx"]})]})]}),e.jsxs(u,{type:"info",title:"Deriving Channel ID",children:[e.jsx("p",{children:"The permanent channel_id is derived from the funding transaction:"}),e.jsx("div",{className:"font-mono text-sm bg-dark-800 p-3 rounded mt-2",children:"channel_id = funding_txid XOR funding_output_index"}),e.jsx("p",{className:"mt-2",children:"The output index is left-padded with zeros to 32 bytes before XOR."})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Channel Ready"}),e.jsx("p",{className:"mb-4",children:"After the funding transaction has sufficient confirmations (per minimum_depth), both parties send channel_ready:"}),e.jsxs(r,{title:"channel_ready (type 36)",children:["Signals that the channel is ready for use:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"channel_id:"})," The permanent channel identifier"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"second_per_commitment_point:"})," For the second commitment tx"]})]})]}),e.jsx("p",{className:"mb-4",children:"Once both parties have exchanged channel_ready, the channel is operational and can route payments."}),e.jsxs(u,{type:"success",title:"Zero-Conf Channels",children:["With the ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"option_zeroconf"})," feature, channels can be used before any confirmations. The fundee trusts the funder not to double-spend the funding transaction."]})]})}export{B as default};
