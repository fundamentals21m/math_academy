import{j as e}from"./vendor-animation-0o8UKZ_1.js";import"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-DFrfwBbR.js";import{L as c,D as s,E as t,C as i,T as l}from"./Callout-DlDYJSPr.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";function p(){return e.jsxs(c,{sectionId:11,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"HTLC Transactions"}),e.jsx("p",{className:"mb-4",children:"HTLC (Hash Time-Locked Contract) outputs in commitment transactions require their own transactions to resolve. This section covers HTLC-success and HTLC-timeout transactions, their scripts, and witness requirements."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"HTLC Output Scripts"}),e.jsx("p",{className:"mb-4",children:"HTLC outputs in commitment transactions use complex scripts with multiple spending paths:"}),e.jsxs(s,{title:"Offered HTLC Script",children:[e.jsx("p",{className:"mb-2",children:"For HTLCs offered by the commitment transaction holder:"}),e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded space-y-1",children:[e.jsx("p",{children:"OP_DUP OP_HASH160 <RIPEMD160(revocationpubkey)> OP_EQUAL"}),e.jsx("p",{children:"OP_IF"}),e.jsx("p",{className:"pl-4",children:"OP_CHECKSIG"}),e.jsx("p",{children:"OP_ELSE"}),e.jsx("p",{className:"pl-4",children:"<remote_htlcpubkey> OP_SWAP OP_SIZE 32 OP_EQUAL"}),e.jsx("p",{className:"pl-4",children:"OP_NOTIF"}),e.jsx("p",{className:"pl-8",children:"OP_DROP 2 OP_SWAP <local_htlcpubkey> 2 OP_CHECKMULTISIG"}),e.jsx("p",{className:"pl-4",children:"OP_ELSE"}),e.jsx("p",{className:"pl-8",children:"OP_HASH160 <RIPEMD160(payment_hash)> OP_EQUALVERIFY"}),e.jsx("p",{className:"pl-8",children:"OP_CHECKSIG"}),e.jsx("p",{className:"pl-4",children:"OP_ENDIF"}),e.jsx("p",{children:"OP_ENDIF"})]})]}),e.jsx("p",{className:"mt-4 mb-4",children:"This script has three spending paths:"}),e.jsx(t,{title:"Offered HTLC Spending Paths",children:e.jsxs("ol",{className:"list-decimal list-inside space-y-2",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Revocation:"})," Counterparty uses revocation key to claim (if commitment is revoked)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"HTLC-success:"})," Remote party provides preimage to claim payment"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"HTLC-timeout:"})," Local party reclaims after CLTV expiry via HTLC-timeout transaction"]})]})}),e.jsxs(s,{title:"Received HTLC Script",children:[e.jsx("p",{className:"mb-2",children:"For HTLCs received by the commitment transaction holder:"}),e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded space-y-1",children:[e.jsx("p",{children:"OP_DUP OP_HASH160 <RIPEMD160(revocationpubkey)> OP_EQUAL"}),e.jsx("p",{children:"OP_IF"}),e.jsx("p",{className:"pl-4",children:"OP_CHECKSIG"}),e.jsx("p",{children:"OP_ELSE"}),e.jsx("p",{className:"pl-4",children:"<remote_htlcpubkey> OP_SWAP OP_SIZE 32 OP_EQUAL"}),e.jsx("p",{className:"pl-4",children:"OP_IF"}),e.jsx("p",{className:"pl-8",children:"OP_HASH160 <RIPEMD160(payment_hash)> OP_EQUALVERIFY"}),e.jsx("p",{className:"pl-8",children:"2 OP_SWAP <local_htlcpubkey> 2 OP_CHECKMULTISIG"}),e.jsx("p",{className:"pl-4",children:"OP_ELSE"}),e.jsx("p",{className:"pl-8",children:"OP_DROP <cltv_expiry> OP_CHECKLOCKTIMEVERIFY"}),e.jsx("p",{className:"pl-8",children:"OP_DROP OP_CHECKSIG"}),e.jsx("p",{className:"pl-4",children:"OP_ENDIF"}),e.jsx("p",{children:"OP_ENDIF"})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"HTLC-Success Transaction"}),e.jsx("p",{className:"mb-4",children:"When a received HTLC can be claimed with the preimage, an HTLC-success transaction is used:"}),e.jsx(s,{title:"HTLC-Success Transaction",children:e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Input:"})," The received HTLC output from commitment tx"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Output:"})," Goes to a delayed local output (with revocation)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Locktime:"})," 0"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Sequence:"})," 0 (no RBF)"]})]})}),e.jsx(t,{title:"HTLC-Success Witness",children:e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded space-y-1",children:[e.jsx("p",{children:"witness[0]: (empty for CHECKMULTISIG)"}),e.jsx("p",{children:"witness[1]: <remote_htlcsig>"}),e.jsx("p",{children:"witness[2]: <local_htlcsig>"}),e.jsx("p",{children:"witness[3]: <payment_preimage>"}),e.jsx("p",{children:"witness[4]: <htlc_script>"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"HTLC-Timeout Transaction"}),e.jsx("p",{className:"mb-4",children:"When an offered HTLC expires without being claimed, an HTLC-timeout transaction returns the funds:"}),e.jsx(s,{title:"HTLC-Timeout Transaction",children:e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Input:"})," The offered HTLC output from commitment tx"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Output:"})," Goes to a delayed local output (with revocation)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Locktime:"})," Set to the HTLC's cltv_expiry"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Sequence:"})," 0"]})]})}),e.jsx(t,{title:"HTLC-Timeout Witness",children:e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded space-y-1",children:[e.jsx("p",{children:"witness[0]: (empty for CHECKMULTISIG)"}),e.jsx("p",{children:"witness[1]: <remote_htlcsig>"}),e.jsx("p",{children:"witness[2]: <local_htlcsig>"}),e.jsx("p",{children:"witness[3]: (empty - no preimage)"}),e.jsx("p",{children:"witness[4]: <htlc_script>"})]})}),e.jsx(i,{type:"info",title:"Why Second-Stage Transactions?",children:"HTLC-success and HTLC-timeout transactions add a delay before the local party can spend. This gives the counterparty time to use the revocation key if the commitment was revoked."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"HTLC Transaction Output"}),e.jsx("p",{className:"mb-4",children:"Both HTLC-success and HTLC-timeout outputs use the same delayed script:"}),e.jsxs(s,{title:"HTLC Transaction Output Script",children:[e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded space-y-1",children:[e.jsx("p",{children:"OP_IF"}),e.jsx("p",{className:"pl-4",children:"<revocationpubkey>"}),e.jsx("p",{children:"OP_ELSE"}),e.jsx("p",{className:"pl-4",children:"<to_self_delay> OP_CHECKSEQUENCEVERIFY OP_DROP"}),e.jsx("p",{className:"pl-4",children:"<local_delayedpubkey>"}),e.jsx("p",{children:"OP_ENDIF"}),e.jsx("p",{children:"OP_CHECKSIG"})]}),e.jsx("p",{className:"mt-2",children:"Identical to the to_local commitment output script."})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Signature Requirements"}),e.jsxs(l,{title:"Pre-Signed HTLC Transactions",children:["The remote party's signature for HTLC transactions is included in commitment_signed. This means:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsx("li",{children:"HTLC transactions can be broadcast without further cooperation"}),e.jsx("li",{children:"All signatures use SIGHASH_ALL"}),e.jsx("li",{children:"Signatures must be LOW-S normalized (BIP-0062)"})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Zero-Fee HTLC Transactions"}),e.jsxs("p",{className:"mb-4",children:["With ",e.jsx("code",{className:"bg-dark-800 px-1 rounded",children:"option_anchors_zero_fee_htlc_tx"}),", HTLC transactions are created with zero fees:"]}),e.jsx(i,{type:"success",title:"Zero-Fee Benefits",children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Fees are added via CPFP on the anchor outputs"}),e.jsx("li",{children:"No need to predict future fee rates when signing"}),e.jsx("li",{children:"HTLC signatures use SIGHASH_SINGLE|SIGHASH_ANYONECANPAY"}),e.jsx("li",{children:"Additional inputs can be added to pay fees"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"HTLC Resolution Timeline"}),e.jsx(t,{title:"HTLC Lifecycle",children:e.jsxs("div",{className:"space-y-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"1. HTLC Added"}),e.jsx("p",{className:"text-dark-300",children:"update_add_htlc sent with payment_hash and cltv_expiry"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"2. HTLC Committed"}),e.jsx("p",{className:"text-dark-300",children:"commitment_signed includes HTLC output and signatures"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"3a. Success Path"}),e.jsx("p",{className:"text-dark-300",children:"Preimage received → update_fulfill_htlc"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"3b. Timeout Path"}),e.jsx("p",{className:"text-dark-300",children:"No preimage by cltv_expiry → update_fail_htlc"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"4. On-Chain (if needed)"}),e.jsx("p",{className:"text-dark-300",children:"Broadcast commitment + HTLC-success/timeout tx"})]})]})})]})}export{p as default};
