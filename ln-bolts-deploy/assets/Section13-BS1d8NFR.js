import{j as e}from"./vendor-animation-0o8UKZ_1.js";import"./vendor-react-Drj8qL0h.js";import"./vendor-math-p018AHG0.js";import"./index-DFrfwBbR.js";import{L as l,D as i,T as s,E as t,C as n}from"./Callout-DlDYJSPr.js";import"./vendor-firebase-core-BXWtuYvb.js";import"./quizMap-C4dST7Re.js";function x(){return e.jsxs(l,{sectionId:13,children:[e.jsx("h2",{className:"text-2xl font-bold text-dark-100 mb-6",children:"BOLT #5: Mutual Close"}),e.jsx("p",{className:"mb-4",children:"BOLT #5 specifies how to handle on-chain transactions when a channel closes. A mutual close is the cooperative path where both parties agree to close the channel and sign a closing transaction together."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Mutual Close Overview"}),e.jsx("p",{className:"mb-4",children:"A mutual close occurs when both parties cooperatively close the channel using the negotiation process defined in BOLT #2 (shutdown â†’ closing_signed/closing_complete)."}),e.jsxs(i,{title:"Closing Transaction",children:["A simple transaction that distributes the channel balance:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Input:"})," The funding output (2-of-2 multisig)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Outputs:"})," One per party (if above dust)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"No timelocks:"})," Immediately spendable"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"No HTLCs:"})," All must be resolved first"]})]})]}),e.jsxs(s,{title:"Mutual Close Benefits",children:["Compared to unilateral close:",e.jsxs("ul",{className:"mt-2 list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Lower fees (simpler transaction, no HTLC outputs)"}),e.jsx("li",{children:"Immediate access to funds (no CSV delay)"}),e.jsx("li",{children:"Better privacy (indistinguishable from normal 2-of-2 spends)"}),e.jsx("li",{children:"Smaller on-chain footprint"})]})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Prerequisites for Mutual Close"}),e.jsx("p",{className:"mb-4",children:"Before a mutual close can proceed:"}),e.jsx(t,{title:"Mutual Close Requirements",children:e.jsxs("ol",{className:"list-decimal list-inside space-y-2",children:[e.jsx("li",{children:"Both parties have exchanged shutdown messages"}),e.jsx("li",{children:"No pending update_add_htlc messages after shutdown"}),e.jsx("li",{children:"All existing HTLCs have been resolved (fulfilled or failed)"}),e.jsx("li",{children:"All pending commitments have been irrevocably committed"})]})}),e.jsx(n,{type:"warning",title:"HTLC Resolution",children:"HTLCs cannot be removed from the closing transaction. They must be resolved off-chain before the closing negotiation begins. If an HTLC times out during the closing process, the node should fail it with update_fail_htlc."}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Closing Transaction Construction"}),e.jsx("p",{className:"mb-4",children:"The closing transaction follows a simple format:"}),e.jsx(i,{title:"Closing Transaction Format",children:e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded space-y-1",children:[e.jsx("p",{children:"version: 2"}),e.jsx("p",{children:"locktime: 0"}),e.jsx("p",{children:"vin[0]:"}),e.jsx("p",{className:"pl-4",children:"txid: funding_txid"}),e.jsx("p",{className:"pl-4",children:"vout: funding_output_index"}),e.jsx("p",{className:"pl-4",children:"sequence: 0xFFFFFFFF"}),e.jsx("p",{children:"vout[0..1]: outputs to each party's scriptpubkey"})]})}),e.jsxs(s,{title:"Output Ordering",children:["Outputs are ordered according to BIP-69:",e.jsxs("ol",{className:"list-decimal list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"By value (ascending)"}),e.jsx("li",{children:"By scriptPubKey length (ascending)"}),e.jsx("li",{children:"By scriptPubKey bytes (lexicographic)"})]}),"Outputs below the dust limit are omitted (value goes to fees)."]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Signature Exchange"}),e.jsx("p",{className:"mb-4",children:"Each party signs the closing transaction and exchanges signatures:"}),e.jsxs(t,{title:"Mutual Close Signature",children:[e.jsxs("div",{className:"font-mono text-xs bg-dark-800 p-3 rounded space-y-1",children:[e.jsx("p",{children:"witness[0]: (empty for CHECKMULTISIG)"}),e.jsx("p",{children:"witness[1]: <signature from party A>"}),e.jsx("p",{children:"witness[2]: <signature from party B>"}),e.jsx("p",{children:"witness[3]: <2-of-2 multisig script>"})]}),e.jsx("p",{className:"mt-2 text-sm text-dark-300",children:"Signatures ordered by public key (same ordering as in the multisig script)."})]}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Node Requirements"}),e.jsx("p",{className:"mb-4",children:"After the closing transaction is broadcast, nodes must:"}),e.jsx(s,{title:"Post-Mutual-Close Actions",children:e.jsxs("ul",{className:"list-disc list-inside space-y-2 mt-2",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Monitor for confirmation:"})," Wait for the closing transaction to be mined in a block."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Handle reorgs:"})," If the closing transaction becomes unconfirmed due to a reorg, continue monitoring."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Resolve at depth 100:"}),' After 100 confirmations, the output is considered "irrevocably resolved."']}),e.jsxs("li",{children:[e.jsx("strong",{children:"Cleanup state:"})," Channel data can be archived or deleted after funds are resolved."]})]})}),e.jsx("h3",{className:"text-xl font-semibold text-dark-100 mt-8 mb-4",children:"Fee Considerations"}),e.jsx("p",{className:"mb-4",children:"In the legacy protocol, the funder pays the closing transaction fee. In the simple close protocol, each party pays their own fee based on their output."}),e.jsx(t,{title:"Fee Distribution Examples",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-dark-700",children:[e.jsx("th",{className:"text-left py-2",children:"Protocol"}),e.jsx("th",{className:"text-left py-2",children:"Fee Payment"})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{className:"border-b border-dark-800",children:[e.jsx("td",{className:"py-2",children:"Legacy (closing_signed)"}),e.jsx("td",{className:"py-2",children:"Funder pays entire fee"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2",children:"Simple (closing_complete)"}),e.jsx("td",{className:"py-2",children:"Each pays for own transaction"})]})]})]})}),e.jsxs(n,{type:"info",title:"RBF for Closing Transactions",children:["If the closing transaction doesn't confirm in a timely manner, nodes can:",e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Re-negotiate a higher fee (if peer is cooperative)"}),e.jsx("li",{children:"Use CPFP if they have an output (spend their output with a higher fee)"}),e.jsx("li",{children:"As a last resort, broadcast commitment transaction (unilateral close)"})]})]})]})}export{x as default};
