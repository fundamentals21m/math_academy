import{j as e}from"./vendor-animation-0o8UKZ_1.js";import{u as M,s as E,g as T,i as O,a as S,b as W,v as I,R as q,L as K,f as G}from"./index-i3-6WrBj.js";import{r as i}from"./vendor-react-Drj8qL0h.js";import{h as A}from"./vendor-firebase-functions-DDqfDrvm.js";import"./vendor-math-p018AHG0.js";import"./vendor-firebase-core-CzRQL6VN.js";import"./vendor-firebase-auth-C4l3lITM.js";function D({className:t="",showDisplayName:s=!0}){var u,v;const{isAuthenticated:r,isConnecting:a,npub:d,displayName:c,hasExtension:x,extensionChecked:b,error:h,connect:l,disconnect:g,clearError:f}=M();return b?r?e.jsxs("div",{className:`flex items-center gap-3 ${t}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-purple-500 flex items-center justify-center text-white text-xs font-bold",children:((u=c==null?void 0:c[0])==null?void 0:u.toUpperCase())||((v=d==null?void 0:d[5])==null?void 0:v.toUpperCase())||"?"}),e.jsxs("div",{className:"flex flex-col",children:[s&&c&&e.jsx("span",{className:"text-sm font-medium text-dark-100",children:c}),e.jsx("span",{className:"text-xs text-dark-400 font-mono",children:d?E(d,6):"..."})]})]}),e.jsx("button",{onClick:g,className:"p-1.5 rounded-lg text-dark-400 hover:text-dark-200 hover:bg-dark-700/50 transition-colors",title:"Disconnect",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"})})})]}):e.jsxs("div",{className:`flex flex-col items-center gap-2 ${t}`,children:[e.jsx("button",{onClick:()=>{l()},disabled:a||!x,className:`
            flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm
            transition-all duration-200
            ${x?a?"bg-primary-600 text-white opacity-70 cursor-wait":"bg-primary-600 hover:bg-primary-500 text-white shadow-lg shadow-primary-600/25":"bg-dark-700 text-dark-400 cursor-not-allowed"}
          `,children:a?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Connecting..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"})}),"Connect with Nostr"]})}),!x&&e.jsxs("p",{className:"text-xs text-dark-400 text-center max-w-xs",children:["Install a Nostr extension like"," ",e.jsx("a",{href:"https://github.com/nickytonline/nos2x",target:"_blank",rel:"noopener noreferrer",className:"text-primary-400 hover:underline",children:"nos2x"})," ","or"," ",e.jsx("a",{href:"https://getalby.com",target:"_blank",rel:"noopener noreferrer",className:"text-primary-400 hover:underline",children:"Alby"})," ","to connect"]}),h&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-red-400",children:[e.jsx("span",{children:h}),e.jsx("button",{onClick:f,className:"text-dark-400 hover:text-dark-200",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}):e.jsxs("div",{className:`flex items-center gap-2 ${t}`,children:[e.jsx("div",{className:"w-4 h-4 border-2 border-dark-400 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-dark-400 text-sm",children:"Checking..."})]})}function X(t){switch(t){case 1:return{emoji:"1st",bgColor:"bg-yellow-500/20",textColor:"text-yellow-400",borderColor:"border-yellow-500/30"};case 2:return{emoji:"2nd",bgColor:"bg-gray-400/20",textColor:"text-gray-300",borderColor:"border-gray-400/30"};case 3:return{emoji:"3rd",bgColor:"bg-orange-500/20",textColor:"text-orange-400",borderColor:"border-orange-500/30"};default:return{emoji:`${t}`,bgColor:"bg-dark-700/50",textColor:"text-dark-300",borderColor:"border-dark-600/30"}}}function Q({entry:t,isCurrentUser:s}){var a,d,c;const r=X(t.rank);return e.jsxs("div",{className:`
        flex items-center gap-4 p-3 rounded-xl transition-colors
        ${s?"bg-primary-500/10 border border-primary-500/30":"hover:bg-dark-700/30"}
      `,children:[e.jsx("div",{className:`
          w-10 h-10 rounded-lg ${r.bgColor} ${r.borderColor} border
          flex items-center justify-center font-bold ${r.textColor}
          ${t.rank<=3?"text-lg":"text-sm"}
        `,children:r.emoji}),e.jsx("div",{className:`
          w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold
          ${t.rank===1?"bg-gradient-to-br from-yellow-400 to-yellow-600":t.rank===2?"bg-gradient-to-br from-gray-300 to-gray-500":t.rank===3?"bg-gradient-to-br from-orange-400 to-orange-600":"bg-gradient-to-br from-primary-500 to-purple-500"}
        `,children:((d=(a=t.displayName)==null?void 0:a[0])==null?void 0:d.toUpperCase())||((c=t.npub[5])==null?void 0:c.toUpperCase())||"?"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`font-medium truncate ${s?"text-primary-300":"text-dark-100"}`,children:t.displayName||E(t.npub,8)}),s&&e.jsx("span",{className:"text-xs bg-primary-500/20 text-primary-300 px-1.5 py-0.5 rounded",children:"You"})]}),t.displayName&&e.jsx("span",{className:"text-xs text-dark-500 font-mono",children:E(t.npub,6)})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-lg font-bold text-yellow-400",children:[t.xp.toLocaleString(),e.jsx("span",{className:"text-xs text-dark-400 ml-1",children:"XP"})]}),e.jsxs("div",{className:"text-xs text-dark-400",children:["Level ",t.level]})]})]})}function Z(){return e.jsx("div",{className:"space-y-2",children:[1,2,3,4,5].map(t=>e.jsxs("div",{className:"flex items-center gap-4 p-3 rounded-xl animate-pulse",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-dark-700"}),e.jsx("div",{className:"w-10 h-10 rounded-full bg-dark-700"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 bg-dark-700 rounded w-32"}),e.jsx("div",{className:"h-3 bg-dark-700 rounded w-24"})]}),e.jsxs("div",{className:"space-y-2 text-right",children:[e.jsx("div",{className:"h-5 bg-dark-700 rounded w-16 ml-auto"}),e.jsx("div",{className:"h-3 bg-dark-700 rounded w-12 ml-auto"})]})]},t))})}function ee(){return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-4xl mb-3",children:"ðŸ†"}),e.jsx("p",{className:"text-dark-300 font-medium",children:"No rankings yet"}),e.jsx("p",{className:"text-dark-500 text-sm mt-1",children:"Be the first to join the leaderboard!"})]})}function te({rankings:t,currentUserNpub:s,isLoading:r=!1}){return r?e.jsx(Z,{}):t.length===0?e.jsx(ee,{}):e.jsx("div",{className:"space-y-2",children:t.map(a=>e.jsx(Q,{entry:a,isCurrentUser:s===a.npub},a.npub))})}function re({className:t="",showRetry:s=!0}){const[r,a]=i.useState({status:"idle",lastSyncedAt:null,error:null});i.useEffect(()=>T().onStatusChange(a),[]);const d=i.useCallback(()=>{T().syncWithRetry()},[]),c=x=>{if(!x)return"Never";const h=new Date().getTime()-x.getTime(),l=Math.floor(h/1e3),g=Math.floor(l/60);return l<10?"Just now":l<60?`${l}s ago`:g<60?`${g}m ago`:x.toLocaleTimeString()};return r.status==="idle"&&!r.lastSyncedAt?null:e.jsxs("div",{className:`flex items-center gap-2 text-xs ${t}`,children:[r.status==="syncing"&&e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"w-3.5 h-3.5 animate-spin text-primary-400",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("span",{className:"text-dark-400",children:"Syncing..."})]}),r.status==="success"&&e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-3.5 h-3.5 text-emerald-400",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),e.jsxs("span",{className:"text-dark-400",children:["Synced ",c(r.lastSyncedAt)]})]}),r.status==="error"&&e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-3.5 h-3.5 text-red-400",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),e.jsx("span",{className:"text-red-400",children:"Sync failed"}),s&&e.jsx("button",{onClick:d,className:"text-primary-400 hover:text-primary-300 underline",children:"Retry"})]}),r.status==="idle"&&r.lastSyncedAt&&e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-3.5 h-3.5 text-dark-500",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z",clipRule:"evenodd"})}),e.jsxs("span",{className:"text-dark-500",children:["Last synced ",c(r.lastSyncedAt)]})]})]})}function se({rank:t,totalXP:s,level:r,courseXP:a}){var g,f;const{npub:d,displayName:c,nip05:x}=M(),[b,h]=i.useState(!1),l=i.useCallback(()=>{d&&(navigator.clipboard.writeText(d),h(!0),setTimeout(()=>h(!1),2e3))},[d]);return d?e.jsxs("div",{className:"p-5 rounded-2xl bg-gradient-to-br from-primary-500/10 to-purple-500/10 border border-primary-500/20 backdrop-blur",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-gradient-to-br from-primary-500 to-purple-500 flex items-center justify-center text-white text-xl font-bold shadow-lg shadow-primary-500/25",children:((g=c==null?void 0:c[0])==null?void 0:g.toUpperCase())||((f=d[5])==null?void 0:f.toUpperCase())||"?"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[c&&e.jsx("div",{className:"font-semibold text-dark-100 truncate text-lg",children:c}),x&&e.jsxs("div",{className:"text-sm text-dark-300 flex items-center gap-1",children:[e.jsx("span",{className:"truncate",children:x}),e.jsx("svg",{className:"w-3.5 h-3.5 text-primary-400 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})})]}),e.jsxs("button",{onClick:l,className:"text-xs text-dark-400 font-mono break-all text-left hover:text-dark-200 transition-colors group",title:"Click to copy",children:[d,e.jsx("span",{className:"ml-1.5 opacity-0 group-hover:opacity-100 transition-opacity",children:b?"âœ“":"ðŸ“‹"})]})]}),e.jsx("div",{className:"text-right",children:t!==null?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-3xl font-bold text-primary-400",children:["#",t]}),e.jsx("div",{className:"text-xs text-dark-400",children:"Global Rank"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-xl font-bold text-dark-400",children:"--"}),e.jsx("div",{className:"text-xs text-dark-500",children:"Not ranked"})]})})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-dark-700/50 grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-400",children:s.toLocaleString()}),e.jsx("div",{className:"text-xs text-dark-400",children:"Total XP"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-emerald-400",children:r}),e.jsx("div",{className:"text-xs text-dark-400",children:"Level"})]})]}),e.jsx("div",{className:"mt-3 pt-3 border-t border-dark-700/50",children:e.jsx(re,{})}),a&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-dark-700/50",children:[e.jsx("div",{className:"text-xs text-dark-400 mb-2",children:"XP by Course"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"p-2 rounded-lg bg-dark-800/50 text-center",children:[e.jsx("div",{className:"text-sm font-bold text-blue-400",children:(a.ba||0).toLocaleString()}),e.jsx("div",{className:"text-xs text-dark-500",children:"Basic Algebra"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-dark-800/50 text-center",children:[e.jsx("div",{className:"text-sm font-bold text-green-400",children:(a.crypto||0).toLocaleString()}),e.jsx("div",{className:"text-xs text-dark-500",children:"Cryptography"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-dark-800/50 text-center",children:[e.jsx("div",{className:"text-sm font-bold text-purple-400",children:(a.aa||0).toLocaleString()}),e.jsx("div",{className:"text-xs text-dark-500",children:"Abstract Algebra"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-dark-800/50 text-center",children:[e.jsx("div",{className:"text-sm font-bold text-cyan-400",children:(a.linalg||0).toLocaleString()}),e.jsx("div",{className:"text-xs text-dark-500",children:"Linear Algebra"})]}),e.jsxs("div",{className:"p-2 rounded-lg bg-dark-800/50 text-center",children:[e.jsx("div",{className:"text-sm font-bold text-pink-400",children:(a.advlinalg||0).toLocaleString()}),e.jsx("div",{className:"text-xs text-dark-500",children:"Adv. Linear Alg."})]})]})]})]}):null}const ae=W("AdminPanel");function ne({className:t=""}){const{isAdmin:s}=M(),[r,a]=i.useState(""),[d,c]=i.useState(""),[x,b]=i.useState(!1),[h,l]=i.useState(null),[g,f]=i.useState([]),[u,v]=i.useState(!1),N=i.useCallback(async()=>{if(!(!O()||!s))try{const n=S(),m=await A(n,"getAdminLogs")({limit:20});f(m.data.logs)}catch(n){ae.error("Failed to load admin logs:",n)}},[s]);i.useEffect(()=>{u&&N()},[u,N]);const w=async()=>{const n=r.trim();if(!n){l({type:"error",text:"Please enter an npub"});return}const p=I(n);if(!p.valid){l({type:"error",text:p.error||"Invalid npub format"});return}b(!0),l(null);try{const m=S();await A(m,"banUser")({targetNpub:r.trim(),reason:d.trim()||void 0}),l({type:"success",text:"User banned successfully"}),a(""),c(""),u&&N()}catch(m){l({type:"error",text:m instanceof Error?m.message:"Failed to ban user"})}finally{b(!1)}},U=async()=>{const n=r.trim();if(!n){l({type:"error",text:"Please enter an npub"});return}const p=I(n);if(!p.valid){l({type:"error",text:p.error||"Invalid npub format"});return}b(!0),l(null);try{const m=S();await A(m,"unbanUser")({targetNpub:r.trim()}),l({type:"success",text:"User unbanned successfully"}),a(""),u&&N()}catch(m){l({type:"error",text:m instanceof Error?m.message:"Failed to unban user"})}finally{b(!1)}},C=async()=>{const n=r.trim();if(!n){l({type:"error",text:"Please enter an npub"});return}const p=I(n);if(!p.valid){l({type:"error",text:p.error||"Invalid npub format"});return}if(confirm("Are you sure you want to reset this user's scores? This cannot be undone.")){b(!0),l(null);try{const m=S();await A(m,"resetUserScores")({targetNpub:r.trim(),reason:d.trim()||void 0}),l({type:"success",text:"User scores reset successfully"}),a(""),c(""),u&&N()}catch(m){l({type:"error",text:m instanceof Error?m.message:"Failed to reset scores"})}finally{b(!1)}}},R=n=>new Date(n.seconds*1e3).toLocaleString();return s?e.jsxs("div",{className:`p-5 rounded-2xl bg-dark-800/60 border border-dark-700/50 ${t}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-dark-100 flex items-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5 text-yellow-400",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"})}),"Admin Panel"]}),e.jsx("span",{className:"text-xs bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded",children:"Admin"})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-dark-400 mb-1",children:"Target User (npub)"}),e.jsx("input",{type:"text",value:r,onChange:n=>a(n.target.value),placeholder:"npub1...",className:"w-full px-3 py-2 rounded-lg bg-dark-900 border border-dark-600 text-dark-100 text-sm font-mono focus:outline-none focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-dark-400 mb-1",children:"Reason (optional)"}),e.jsx("input",{type:"text",value:d,onChange:n=>c(n.target.value),placeholder:"Reason for action",className:"w-full px-3 py-2 rounded-lg bg-dark-900 border border-dark-600 text-dark-100 text-sm focus:outline-none focus:border-primary-500"})]})]}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx("button",{onClick:w,disabled:x,className:"flex-1 px-3 py-2 rounded-lg bg-red-600/20 border border-red-500/30 text-red-400 text-sm font-medium hover:bg-red-600/30 transition-colors disabled:opacity-50",children:"Ban User"}),e.jsx("button",{onClick:U,disabled:x,className:"flex-1 px-3 py-2 rounded-lg bg-green-600/20 border border-green-500/30 text-green-400 text-sm font-medium hover:bg-green-600/30 transition-colors disabled:opacity-50",children:"Unban User"}),e.jsx("button",{onClick:C,disabled:x,className:"flex-1 px-3 py-2 rounded-lg bg-orange-600/20 border border-orange-500/30 text-orange-400 text-sm font-medium hover:bg-orange-600/30 transition-colors disabled:opacity-50",children:"Reset Scores"})]}),h&&e.jsx("div",{className:`p-3 rounded-lg text-sm mb-4 ${h.type==="success"?"bg-green-500/10 border border-green-500/30 text-green-400":"bg-red-500/10 border border-red-500/30 text-red-400"}`,children:h.text}),e.jsxs("button",{onClick:()=>v(!u),className:"w-full text-sm text-dark-400 hover:text-dark-200 transition-colors flex items-center justify-center gap-1",children:[u?"Hide":"Show"," Admin Logs",e.jsx("svg",{className:`w-4 h-4 transition-transform ${u?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),u&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-dark-700/50",children:[e.jsx("h4",{className:"text-sm font-medium text-dark-200 mb-2",children:"Recent Actions"}),g.length===0?e.jsx("p",{className:"text-xs text-dark-500",children:"No admin actions recorded"}):e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:g.map(n=>e.jsxs("div",{className:"p-2 rounded-lg bg-dark-900/50 text-xs",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:`font-medium ${n.action==="ban"?"text-red-400":n.action==="unban"?"text-green-400":"text-orange-400"}`,children:n.action.toUpperCase()}),e.jsx("span",{className:"text-dark-500",children:R(n.timestamp)})]}),e.jsxs("div",{className:"text-dark-400",children:["Target: ",e.jsx("span",{className:"font-mono",children:E(n.targetNpub,8)})]}),n.reason&&e.jsxs("div",{className:"text-dark-500 mt-1",children:["Reason: ",n.reason]})]},n.id))})]})]}):null}const le=W("Leaderboard"),J="magic-internet-math-leaderboard-cache";function oe(t){try{const s=localStorage.getItem(J);if(!s)return null;const r=JSON.parse(s);return r.tab!==t||Date.now()-r.timestamp>K?null:r}catch{return null}}function ie(t,s,r){try{const a={rankings:t,userRank:s,timestamp:Date.now(),tab:r};localStorage.setItem(J,JSON.stringify(a))}catch{}}function H(t){if(t instanceof Error){const s=t.message.toLowerCase();if(s.includes("unauthenticated")||s.includes("not authenticated"))return"Please connect your Nostr wallet to view the leaderboard.";if(s.includes("permission")||s.includes("denied"))return"You don't have permission to access this resource.";if(s.includes("not-found")||s.includes("not found"))return"The requested data was not found.";if(s.includes("network")||s.includes("fetch")||s.includes("failed to fetch"))return"Network error. Please check your connection and try again.";if(s.includes("timeout")||s.includes("deadline"))return"Request timed out. Please try again."}return"Failed to load leaderboard. Please try again."}const V=[{id:"overall",label:"Overall",shortLabel:"All"},{id:"ba",label:"Basic Algebra",shortLabel:"BA"},{id:"crypto",label:"Cryptography",shortLabel:"Crypto"},{id:"aa",label:"Abstract Algebra",shortLabel:"AA"},{id:"linalg",label:"Linear Algebra",shortLabel:"LinAlg"},{id:"advlinalg",label:"Advanced Linear Algebra",shortLabel:"AdvLinAlg"},{id:"islr",label:"Statistical Learning",shortLabel:"ISLR"},{id:"ra",label:"Real Analysis",shortLabel:"RA"},{id:"calc1",label:"Calculus I",shortLabel:"Calc1"},{id:"calc_lib_art",label:"Calculus (Liberal Arts)",shortLabel:"CalcLA"},{id:"mom",label:"Men of Mathematics",shortLabel:"MoM"},{id:"calc_easy",label:"Calculus Made Easy",shortLabel:"CalcEasy"}];function de({className:t=""}){var _;const{isAuthenticated:s,npub:r,displayName:a,setDisplayName:d,isAdmin:c}=M(),[x,b]=i.useState("overall"),[h,l]=i.useState([]),[g,f]=i.useState(null),[u,v]=i.useState(!0),[N,w]=i.useState(null),[U,C]=i.useState(!1),[R,n]=i.useState(a||""),p=i.useRef(new Map),m=i.useCallback(async()=>{if(!O()){w("Firebase not configured"),v(!1);return}v(!0),w(null);try{const o=S(),k=await A(o,"getLeaderboard")({courseId:x,limit:50});l(k.data.rankings),f(k.data.userRank),ie(k.data.rankings,k.data.userRank,x)}catch(o){le.error("Failed to load leaderboard:",o);const j=oe(x);j?(l(j.rankings),f(j.userRank),w("Showing cached data. "+H(o))):w(H(o))}finally{v(!1)}},[x]);i.useEffect(()=>{m()},[m]),i.useEffect(()=>{(async()=>{const j=h.filter(y=>!y.displayName&&!p.current.has(y.npub)).map(y=>y.npub);if(j.length===0)return;const k=await G(j);k.forEach((y,L)=>{p.current.set(L,y)}),k.size>0&&l(y=>y.map(L=>{const B=p.current.get(L.npub);return!L.displayName&&B?{...L,displayName:B.display_name||B.name||null}:L}))})()},[h]),i.useEffect(()=>{const o=setInterval(m,q);return()=>clearInterval(o)},[m]);const $=T().getLocalScores(),z=$?Object.values($).reduce((o,j)=>o+(j||0),0):0,Y=Math.floor(Math.sqrt(z/100))+1,P=()=>{const o=R.trim().slice(0,30);d(o||null),C(!1)};return e.jsxs("div",{className:`max-w-2xl mx-auto ${t}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-dark-100",children:"Leaderboard"}),e.jsx("p",{className:"text-sm text-dark-400 mt-1",children:"Compete with other learners across all courses"})]}),e.jsx(D,{showDisplayName:!1})]}),s&&e.jsxs("div",{className:"mb-6",children:[e.jsx(se,{rank:g,totalXP:z,level:Y,courseXP:$||void 0}),e.jsx("div",{className:"mt-3 flex items-center gap-2",children:U?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",value:R,onChange:o=>n(o.target.value),placeholder:"Enter display name",maxLength:30,className:"flex-1 px-3 py-1.5 rounded-lg bg-dark-800 border border-dark-600 text-dark-100 text-sm focus:outline-none focus:border-primary-500",autoFocus:!0,onKeyDown:o=>{o.key==="Enter"&&P(),o.key==="Escape"&&C(!1)}}),e.jsx("button",{onClick:P,className:"px-3 py-1.5 rounded-lg bg-primary-600 text-white text-sm hover:bg-primary-500 transition-colors",children:"Save"}),e.jsx("button",{onClick:()=>C(!1),className:"px-3 py-1.5 rounded-lg bg-dark-700 text-dark-300 text-sm hover:bg-dark-600 transition-colors",children:"Cancel"})]}):e.jsx("button",{onClick:()=>{n(a||""),C(!0)},className:"text-sm text-primary-400 hover:text-primary-300 transition-colors",children:a?"Edit display name":"Set display name"})})]}),!s&&e.jsxs("div",{className:"mb-6 p-6 rounded-2xl bg-dark-800/60 border border-dark-700/50 text-center",children:[e.jsx("div",{className:"text-4xl mb-3",children:"ðŸ”"}),e.jsx("h3",{className:"text-lg font-semibold text-dark-100 mb-2",children:"Connect to Join the Leaderboard"}),e.jsx("p",{className:"text-sm text-dark-400 mb-4 max-w-sm mx-auto",children:"Link your Nostr identity to sync your progress and compete with other learners."}),e.jsx(D,{})]}),e.jsx("div",{className:"flex gap-1 p-1 rounded-xl bg-dark-800/60 border border-dark-700/50 mb-4",children:V.map(o=>e.jsxs("button",{onClick:()=>b(o.id),className:`
              flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors
              ${x===o.id?"bg-primary-600 text-white shadow-lg shadow-primary-600/25":"text-dark-300 hover:text-dark-100 hover:bg-dark-700/50"}
            `,children:[e.jsx("span",{className:"hidden sm:inline",children:o.label}),e.jsx("span",{className:"sm:hidden",children:o.shortLabel})]},o.id))}),N&&e.jsxs("div",{className:"mb-4 p-3 rounded-lg bg-red-500/10 border border-red-500/30 text-red-400 text-sm",children:[N,e.jsx("button",{onClick:m,className:"ml-2 underline hover:no-underline",children:"Retry"})]}),e.jsxs("div",{className:"p-4 rounded-2xl bg-dark-800/60 border border-dark-700/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"font-semibold text-dark-100",children:[(_=V.find(o=>o.id===x))==null?void 0:_.label," Rankings"]}),e.jsx("button",{onClick:m,disabled:u,className:"text-xs text-dark-400 hover:text-dark-200 transition-colors disabled:opacity-50",children:u?"Loading...":"Refresh"})]}),e.jsx(te,{rankings:h,currentUserNpub:r,isLoading:u})]}),c&&e.jsx(ne,{className:"mt-6"}),e.jsx("p",{className:"mt-4 text-xs text-dark-500 text-center",children:"Scores sync automatically when you're connected. Rankings update every few minutes."})]})}function ge(){return e.jsx("div",{className:"max-w-4xl mx-auto px-4 py-8",children:e.jsx(de,{})})}export{ge as default};
